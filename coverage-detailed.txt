
> nexus-vmp-canon@0.1.0 test:coverage
> vitest run --coverage


 RUN  v4.0.16 C:/AI-BOS/AIBOS-VMP
      Coverage enabled with v8

 Ô£ô tests/utils/checklist-rules.test.js (13 tests) 61ms
 Ô£ô tests/server-nunjucks-filters.test.js (20 tests) 261ms
stdout | tests/days5-8.test.js > Days 5-8: Case Detail Functionality
Checking prerequisites...

 Ô£ô tests/server-timeout-middleware.test.js (2 tests) 164ms
stdout | tests/days5-8.test.js > Days 5-8: Case Detail Functionality
Ô£à Found test case: 64a0d83f-7512-4ca9-9cbc-fb0bb1db5340

stdout | tests/days5-8.test.js > Days 5-8: Case Detail Functionality
Ô£à Created test session: b3e80ce27586c00c5c7da0d466964bf313c0f054a304a9569735db816d790e08

node.exe : stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept PDF files
At line:1 char:1
+ & "C:\nvm4w\nodejs/node.exe" "C:\nvm4w\nodejs/node_modules/npm/bin/np ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (stderr | tests/...ccept PDF files:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept PDF files
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-extended.test.js > Server Extended Routes > Home Routes with Data > GET /home3 should handle 
adapter errors gracefully
Error loading cases for home3: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-extended.test.js:80:55
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept JPEG images
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept JPEG images
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Route Error Paths > GET /home3 should 
handle adapter errors
Error loading cases for home3: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:138:55
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Route Error Paths > GET /home4 should 
handle adapter errors
Error loading cases for home4: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:153:55
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept PNG images
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept PNG images
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Route Error Paths > GET /home5 should 
handle adapter errors
Error loading metrics for home5: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:168:55
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept Word documents
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept Word documents
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stdout | tests/days5-8.test.js > Days 5-8: Case Detail Functionality > Prerequisites Check > Storage bucket check (manual verification required)
ÔÜá´©Å  Manual check required: Verify vmp-evidence bucket exists in Supabase Storage
   See: migrations/007_storage_bucket_setup.sql for setup instructions

 Ô£ô tests/days5-8.test.js (29 tests) 5828ms
       Ô£ô GET /partials/case-detail.html should return 200 with case_id  317ms
       Ô£ô GET /partials/case-checklist.html should return 200  504ms
       Ô£ô Case detail should load all cells via HTMX  1177ms
       Ô£ô Message posting should refresh thread  516ms
       Ô£ô vmpAdapter.ensureChecklistSteps should create steps for invoice case  395ms
stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept Excel documents
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should accept Excel documents
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-middleware.test.js > Server Middleware > Multer File Filter > should accept PDF files
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-middleware.test.js > Server Middleware > Multer File Filter > should accept PDF files
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should reject disallowed file types
Error: Error: File type application/x-msdos-program not allowed. Allowed types: PDF, images, Word, Excel
    at fileFilter (C:/AI-BOS/AIBOS-VMP/server.js:49:10)
    at wrappedFileFilter (C:\AI-BOS\AIBOS-VMP\node_modules\multer\index.js:44:7)
    at Multipart.<anonymous> (C:\AI-BOS\AIBOS-VMP\node_modules\multer\lib\make-middleware.js:109:7)
    at Multipart.emit (node:events:519:28)
    at HeaderParser.cb (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:358:14)
    at HeaderParser.push (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:162:20)
    at SBMH.ssCb [as _cb] (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:394:37)
    at feed (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:219:14)
    at SBMH.push (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:104:16)
    at Multipart._write (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:567:19) {
  storageErrors: []
}

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Partial Route Error Paths > GET 
/partials/case-detail.html should handle adapter errors
Adapter error: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:213:60
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Partial Route Error Paths > GET 
/partials/case-thread.html should handle adapter errors
Adapter error loading messages: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:228:58
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-multer-file-filter.test.js > Multer File Filter > should enforce file size limit
Error: MulterError: File too large
    at abortWithCode (C:\AI-BOS\AIBOS-VMP\node_modules\multer\lib\make-middleware.js:73:22)
    at FileStream.<anonymous> (C:\AI-BOS\AIBOS-VMP\node_modules\multer\lib\make-middleware.js:136:11)
    at FileStream.emit (node:events:519:28)
    at SBMH.ssCb [as _cb] (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:479:32)
    at feed (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:248:10)
    at SBMH.push (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:104:16)
    at Multipart._write (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:567:19)
    at writeOrBuffer (node:internal/streams/writable:572:12)
    at _write (node:internal/streams/writable:501:10)
    at Multipart.Writable.write (node:internal/streams/writable:510:10) {
  code: 'LIMIT_FILE_SIZE',
  field: 'file',
  storageErrors: []
}

 Ô£ô tests/server-multer-file-filter.test.js (7 tests) 7523ms
     Ô£ô should accept PDF files  1974ms
     Ô£ô should accept JPEG images  1090ms
     Ô£ô should accept PNG images  1071ms
     Ô£ô should accept Word documents  1137ms
     Ô£ô should accept Excel documents  1055ms
     Ô£ô should reject disallowed file types  542ms
     Ô£ô should enforce file size limit  648ms
stderr | tests/server-middleware.test.js > Server Middleware > Multer File Filter > should accept image files
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-middleware.test.js > Server Middleware > Multer File Filter > should accept image files
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > Partial Route Error Paths > GET 
/partials/case-checklist.html should handle ensureChecklistSteps errors
Error ensuring checklist steps: Error: Database error
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:243:67
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-middleware.test.js > Server Middleware > Multer File Filter > should reject disallowed file types
Error: Error: File type application/x-msdos-program not allowed. Allowed types: PDF, images, Word, Excel
    at fileFilter (C:/AI-BOS/AIBOS-VMP/server.js:49:10)
    at wrappedFileFilter (C:\AI-BOS\AIBOS-VMP\node_modules\multer\index.js:44:7)
    at Multipart.<anonymous> (C:\AI-BOS\AIBOS-VMP\node_modules\multer\lib\make-middleware.js:109:7)
    at Multipart.emit (node:events:519:28)
    at HeaderParser.cb (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:358:14)
    at HeaderParser.push (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:162:20)
    at SBMH.ssCb [as _cb] (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:394:37)
    at feed (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:219:14)
    at SBMH.push (C:\AI-BOS\AIBOS-VMP\node_modules\streamsearch\lib\sbmh.js:104:16)
    at Multipart._write (C:\AI-BOS\AIBOS-VMP\node_modules\busboy\lib\types\multipart.js:567:19) {
  storageErrors: []
}

 Ô£ô tests/server-middleware.test.js (14 tests) 10497ms
       Ô£ô should allow public routes without authentication  1110ms
       Ô£ô should redirect protected routes without session  587ms
       Ô£ô should allow test auth bypass in test mode  578ms
       Ô£ô should handle expired session  898ms
       Ô£ô should handle inactive user  931ms
       Ô£ô should handle auth middleware errors gracefully  863ms
       Ô£ô should accept PDF files  1289ms
       Ô£ô should accept image files  1105ms
       Ô£ô should reject disallowed file types  525ms
       Ô£ô should allow requests within limit  511ms
       Ô£ô should handle 404 for non-existent routes  516ms
       Ô£ô should handle async errors in routes  513ms
       Ô£ô upper filter should uppercase strings  518ms
       Ô£ô tojson filter should stringify objects  530ms
stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > POST Route Error Paths > POST 
/cases/:id/evidence should handle upload errors
Error uploading evidence: Error: Upload failed
    at C:/AI-BOS/AIBOS-VMP/tests/server-error-paths.test.js:333:61
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:145:11
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:915:26
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1209:10)
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:37
    at Traces.$ (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)
    at trace (file:///C:/AI-BOS/AIBOS-VMP/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)
    at runTest (file:///C:/AI-BOS/AIBOS-VMP/node_modules/@vitest/runner/dist/index.js:1653:12)

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > POST Route Error Paths > POST 
/cases/:id/evidence should handle refresh errors after upload
Storage Upload Error: StorageApiError: Bucket not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

stderr | tests/server-error-paths.test.js > Server Error Paths and Edge Cases > POST Route Error Paths > POST 
/cases/:id/evidence should handle refresh errors after upload
Error uploading evidence: Error: Failed to upload to storage: Bucket not found
    at Object.uploadEvidenceToStorage (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:559:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at Object.uploadEvidence (C:/AI-BOS/AIBOS-VMP/src/adapters/supabase.js:600:9)
    at C:/AI-BOS/AIBOS-VMP/server.js:803:7

 Ô£ô tests/server-error-paths.test.js (23 tests) 13295ms
       Ô£ô 404 handler should render error page  971ms
       Ô£ô Global error handler should catch async errors  501ms
       Ô£ô POST /login should handle inactive user  596ms
       Ô£ô POST /login should handle login errors gracefully  519ms
       Ô£ô GET /login should redirect if already logged in  498ms
       Ô£ô GET /home3 should handle adapter errors  490ms
       Ô£ô GET /home4 should handle adapter errors  496ms
       Ô£ô GET /home5 should handle adapter errors  489ms
       Ô£ô GET /test should handle template errors  483ms
       Ô£ô GET /examples should handle template errors  476ms
       Ô£ô GET /components should handle template errors  492ms
       Ô£ô GET /snippets-test should handle template errors  474ms
       Ô£ô GET /partials/case-detail.html should handle adapter errors  487ms
       Ô£ô GET /partials/case-thread.html should handle adapter errors  493ms
       Ô£ô GET /partials/case-checklist.html should handle ensureChecklistSteps errors  819ms
       Ô£ô GET /partials/case-evidence.html should handle signed URL errors  674ms
       Ô£ô POST /cases/:id/messages should handle createMessage errors  638ms
       Ô£ô POST /cases/:id/messages should handle getMessages errors after creation  480ms
       Ô£ô POST /cases/:id/evidence should handle case verification errors  487ms
       Ô£ô POST /cases/:id/evidence should handle upload errors  642ms
       Ô£ô POST /cases/:id/evidence should handle refresh errors after upload  1095ms
       Ô£ô POST /logout should handle deleteSession errors  498ms
       Ô£ô POST /logout should work without session  487ms
stderr | tests/adapters/supabase.test.js > VMP Adapter - Supabase > Evidence Methods > getEvidenceSignedUrl should 
throw error for invalid path
Signed URL Error: StorageApiError: Object not found
    at file:///C:/AI-BOS/AIBOS-VMP/node_modules/@supabase/storage-js/dist/index.mjs:166:10
    at processTicksAndRejections (node:internal/process/task_queues:105:5) {
  __isStorageError: true,
  status: 400,
  statusCode: '404'
}

 Ô£ô tests/server.test.js (35 tests) 18654ms
       Ô£ô GET /health should return 200 with status ok  995ms
       Ô£ô GET / should render landing page  828ms
       Ô£ô GET /login should return 200  534ms
       Ô£ô GET /login2 should return 200  528ms
       Ô£ô GET /login3 should return 200  507ms
       Ô£ô GET /login4 should return 200  510ms
       Ô£ô GET /examples should return 200, redirect, or handle errors  521ms
       Ô£ô GET /nonexistent should return 404 when bypassing auth  509ms
       Ô£ô POST /login should redirect to /home on success  513ms
       Ô£ô POST /login should show error for missing email  507ms
       Ô£ô POST /login should show error for missing password  498ms
       Ô£ô POST /login should show error for invalid credentials  498ms
       Ô£ô POST /logout should redirect to /login  493ms
       Ô£ô GET /home should redirect to /login when not authenticated  493ms
       Ô£ô GET /home should return 200 when authenticated  500ms
       Ô£ô GET /home2 should redirect to /login when not authenticated  506ms
       Ô£ô GET /home2 should return 200 when authenticated  498ms
       Ô£ô GET /dashboard should redirect to /login when not authenticated  515ms
       Ô£ô GET /home3 should redirect to /login when not authenticated  517ms
       Ô£ô GET /home4 should redirect to /login when not authenticated  506ms
       Ô£ô GET /home5 should redirect to /login when not authenticated  504ms
       Ô£ô GET /partials/case-inbox.html should redirect when not authenticated  499ms
       Ô£ô GET /partials/case-detail.html should redirect when not authenticated  546ms
       Ô£ô GET /partials/case-thread.html should redirect when not authenticated  508ms
       Ô£ô GET /partials/case-checklist.html should redirect when not authenticated  501ms
       Ô£ô GET /partials/case-evidence.html should redirect when not authenticated  511ms
       Ô£ô GET /partials/escalation.html should redirect when not authenticated  506ms
       Ô£ô GET /partials/login-help-access.html should return 200  503ms
       Ô£ô GET /partials/login-help-sso.html should return 200  519ms
       Ô£ô GET /partials/login-help-security.html should return 200  508ms
       Ô£ô GET /partials/file-upload-dropzone.html should redirect when not authenticated  496ms
       Ô£ô GET /partials/avatar-component.html should redirect when not authenticated  511ms
       Ô£ô GET /partials/oauth-github-button.html should redirect when not authenticated  505ms
       Ô£ô Should handle 404 errors  533ms
       Ô£ô Should handle server errors gracefully  509ms
 Ô£ô tests/server-extended.test.js (26 tests) 20743ms
       Ô£ô GET /home3 should return 200 when authenticated  1543ms
       Ô£ô GET /home3 should handle adapter errors gracefully  809ms
       Ô£ô GET /home4 should return 200 when authenticated  821ms
       Ô£ô GET /home4 should calculate metrics correctly  821ms
       Ô£ô GET /home5 should return 200 when authenticated  822ms
       Ô£ô GET /home5 should calculate all metrics  798ms
       Ô£ô GET /dashboard should return 200 when authenticated  636ms
       Ô£ô GET /partials/case-inbox.html should return cases when authenticated  799ms
       Ô£ô GET /partials/case-inbox.html should handle missing DEMO_VENDOR_ID  801ms
       Ô£ô GET /partials/case-detail.html should return case detail with caseId  796ms
       Ô£ô GET /partials/case-detail.html should handle missing caseId  649ms
       Ô£ô GET /partials/case-thread.html should return messages with caseId  801ms
       Ô£ô GET /partials/case-thread.html should handle missing caseId  646ms
       Ô£ô GET /partials/case-checklist.html should return checklist with caseId  1167ms
       Ô£ô GET /partials/case-evidence.html should return evidence with caseId  826ms
       Ô£ô GET /partials/escalation.html should return escalation view  637ms
       Ô£ô POST /cases/:id/messages should create message with valid data  804ms
       Ô£ô POST /cases/:id/messages should handle missing caseId  656ms
       Ô£ô POST /cases/:id/messages should handle empty body  799ms
       Ô£ô POST /cases/:id/messages should handle missing body  827ms
       Ô£ô POST /cases/:id/evidence should handle missing file  807ms
       Ô£ô POST /cases/:id/evidence should handle missing evidence_type  823ms
       Ô£ô POST /logout should clear session  644ms
       Ô£ô GET /test should return 200 or redirect  637ms
       Ô£ô GET /snippets-test should return 200 or redirect  649ms
       Ô£ô GET /components should return 200 or redirect  720ms
 Ô£ô tests/server-routes.test.js (29 tests) 22998ms
       Ô£ô GET /partials/case-inbox.html should return 200 when authenticated  1351ms
       Ô£ô GET /partials/case-inbox.html should handle missing DEMO_VENDOR_ID  964ms
       Ô£ô GET /partials/case-detail.html should return 200 with case_id  899ms
       Ô£ô GET /partials/case-detail.html should handle missing case_id  687ms
       Ô£ô GET /partials/case-thread.html should return 200 with case_id  852ms
       Ô£ô GET /partials/case-thread.html should handle missing case_id  685ms
       Ô£ô POST /cases/:id/messages should create a message  847ms
       Ô£ô POST /cases/:id/messages should handle empty message  818ms
       Ô£ô POST /cases/:id/messages should require case_id  683ms
       Ô£ô GET /partials/case-checklist.html should return 200 with case_id  1176ms
       Ô£ô GET /partials/case-checklist.html should handle missing case_id  683ms
       Ô£ô GET /partials/case-evidence.html should return 200 with case_id  829ms
       Ô£ô GET /partials/case-evidence.html should handle missing case_id  684ms
       Ô£ô POST /cases/:id/evidence should handle missing file  818ms
       Ô£ô POST /cases/:id/evidence should reject missing evidence_type  766ms
       Ô£ô GET /partials/escalation.html should return 200 with case_id  847ms
       Ô£ô GET /partials/escalation.html should handle missing case_id  660ms
       Ô£ô GET /home3 should return 200 when authenticated  886ms
       Ô£ô GET /home4 should return 200 when authenticated  832ms
       Ô£ô GET /home5 should return 200 when authenticated  893ms
       Ô£ô POST /partials/login-mock-success.html should return 200  653ms
       Ô£ô POST /partials/login-mock-magic-sent.html should return 200  669ms
       Ô£ô GET /partials/login-mock-forgot.html should return 200  677ms
       Ô£ô GET /partials/login-mock-sso.html should return 200  661ms
       Ô£ô GET /partials/login-mock-passkey.html should return 200  670ms
       Ô£ô GET /partials/login-gate-ritual.html should return 200  663ms
       Ô£ô GET /partials/file-upload-dropzone.html should require authentication  689ms
       Ô£ô Should handle malformed requests gracefully  760ms
       Ô£ô Should handle timeout errors  687ms
stderr | tests/adapters/supabase.test.js > VMP Adapter - Supabase > Error Paths and Edge Cases > getCaseDetail should 
return null for case not belonging to vendor
Case Detail Error: {
  code: '22P02',
  details: null,
  hint: null,
  message: 'invalid input syntax for type uuid: "fake-case-id"'
}

 Ô£ô tests/adapters/supabase.test.js (56 tests) 34189ms
       Ô£ô getUserByEmail should return user for valid email  967ms
       Ô£ô getUserByEmail should return null for invalid email  512ms
       Ô£ô verifyPassword should return false for invalid password  721ms
       Ô£ô createSession should create a session  680ms
       Ô£ô getSession should return session for valid sessionId  897ms
       Ô£ô getSession should return null for invalid sessionId  638ms
       Ô£ô deleteSession should delete a session  956ms
       Ô£ô getVendorContext should return vendor context  642ms
       Ô£ô cleanExpiredSessions should not throw  659ms
       Ô£ô getInbox should return array of cases  634ms
       Ô£ô getInbox should throw error for missing vendorId  468ms
       Ô£ô getCaseDetail should return case for valid caseId  634ms
       Ô£ô getCaseDetail should throw error for missing parameters  486ms
       Ô£ô getMessages should return array of messages  662ms
       Ô£ô getMessages should throw error for missing caseId  493ms
       Ô£ô createMessage should create a message  631ms
       Ô£ô createMessage should throw error for missing parameters  476ms
       Ô£ô createMessage should throw error for invalid sender_type  473ms
       Ô£ô createMessage should throw error for invalid channel_source  496ms
       Ô£ô getChecklistSteps should return array of steps  640ms
       Ô£ô getChecklistSteps should throw error for missing caseId  477ms
       Ô£ô createChecklistStep should create a step  639ms
       Ô£ô createChecklistStep should throw error for missing parameters  483ms
       Ô£ô ensureChecklistSteps should create steps for case type  787ms
       Ô£ô ensureChecklistSteps should throw error for missing parameters  483ms
       Ô£ô getEvidence should return array of evidence  648ms
       Ô£ô getEvidence should throw error for missing caseId  481ms
       Ô£ô computeChecksum should compute SHA-256 hash  473ms
       Ô£ô getNextEvidenceVersion should return 1 for new evidence type  662ms
       Ô£ô getNextEvidenceVersion should throw error for missing parameters  483ms
       Ô£ô generateEvidenceStoragePath should generate valid path  485ms
       Ô£ô generateEvidenceStoragePath should sanitize filename  489ms
       Ô£ô getEvidenceSignedUrl should throw error for invalid path  661ms
       Ô£ô uploadEvidenceToStorage should upload file successfully  468ms
       Ô£ô uploadEvidenceToStorage should throw error on storage failure  468ms
       Ô£ô uploadEvidence should handle storage upload failure with cleanup  481ms
       Ô£ô uploadEvidence should update checklist step status when linked  500ms
       Ô£ô uploadEvidence should handle checklist step update failure gracefully  471ms
       Ô£ô Methods should handle timeouts gracefully  636ms
       Ô£ô verifyPassword should return true for valid password  724ms
       Ô£ô verifyPassword should return false for user without password_hash  720ms
       Ô£ô getSession should auto-delete expired sessions  793ms
       Ô£ô getCaseDetail should return null for case not belonging to vendor  624ms
       Ô£ô getInbox should return empty array for vendor with no cases  647ms
       Ô£ô getMessages should return empty array for case with no messages  652ms
       Ô£ô getChecklistSteps should return empty array for case with no steps  650ms
       Ô£ô getEvidence should return empty array for case with no evidence  656ms
       Ô£ô getNextEvidenceVersion should increment version correctly  624ms
       Ô£ô generateEvidenceStoragePath should sanitize special characters  463ms
       Ô£ô generateEvidenceStoragePath should include date  486ms
       Ô£ô computeChecksum should produce consistent hashes  490ms
       Ô£ô computeChecksum should produce different hashes for different content  524ms
       Ô£ô ensureChecklistSteps should not duplicate existing steps  1146ms
       Ô£ô getVendorContext should throw error for invalid userId  665ms
       Ô£ô deleteSession should handle already deleted session  645ms
       Ô£ô cleanExpiredSessions should not throw  626ms

 Test Files  11 passed (11)
      Tests  254 passed (254)
   Start at  17:22:22
   Duration  36.09s (transform 2.30s, setup 0ms, import 24.15s, tests 134.21s, environment 6ms)

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   68.66 |    63.26 |   82.79 |   68.71 |                   
 AIBOS-VMP         |   66.17 |    55.26 |   76.56 |   65.82 |                   
  server.js        |   66.17 |    55.26 |   76.56 |   65.82 | ...1062,1093-1096 
 ...P/src/adapters |   73.29 |    71.42 |   96.29 |   74.19 |                   
  supabase.js      |   73.29 |    71.42 |   96.29 |   74.19 | ...82,603,627-652 
 ...-VMP/src/utils |     100 |      100 |     100 |     100 |                   
  ...list-rules.js |     100 |      100 |     100 |     100 |                   
-------------------|---------|----------|---------|---------|-------------------
ERROR: Coverage for lines (68.71%) does not meet global threshold (95%)
ERROR: Coverage for functions (82.79%) does not meet global threshold (95%)
ERROR: Coverage for statements (68.66%) does not meet global threshold (95%)
ERROR: Coverage for branches (63.26%) does not meet global threshold (95%)
