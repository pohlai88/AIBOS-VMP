{% extends "nexus/layout.html" %}

{% block title %}AP Queue{% endblock %}

{% set activeNav = 'client' %}

{% block content %}
<div class="nexus-page client-invoices">
  <!-- Header with Stats -->
  <header class="nexus-page-header">
    <div class="nexus-page-header-top">
      <span class="nexus-context-badge client">‚óÄ Client Mode</span>
    </div>
    <div class="nexus-page-header-main">
      <div class="nexus-page-header-content">
        <h1>AP Queue</h1>
        <p>Invoices awaiting review and payment</p>
      </div>
      <div class="nexus-page-header-stats">
        <span class="nexus-inline-stat">
          <strong>{{ pagination.total }}</strong> Invoices
        </span>
        <span class="nexus-inline-stat-divider">‚Ä¢</span>
        <span class="nexus-inline-stat">
          <strong>${{ summary.totalOutstanding | round(2) }}</strong> Outstanding
        </span>
        {% if summary.overdueCount > 0 %}
        <span class="nexus-inline-stat-divider">‚Ä¢</span>
        <span class="nexus-inline-stat danger">
          <strong>{{ summary.overdueCount }}</strong> Overdue
        </span>
        {% endif %}
      </div>
    </div>
  </header>

  <!-- Invoice List Section -->
  <section class="nexus-list-section">
    <div class="nexus-list-header">
      <h2>Invoices</h2>
      <!-- Tabs (C8.1) -->
      <div class="nexus-filter-tabs">
        <a href="/nexus/client/invoices?tab=needs_review"
           class="nexus-filter-tab {% if tab == 'needs_review' %}active{% endif %}">
          Needs Review
        </a>
        <a href="/nexus/client/invoices?tab=approved"
           class="nexus-filter-tab {% if tab == 'approved' %}active{% endif %}">
          Approved
        </a>
        <a href="/nexus/client/invoices?tab=disputed"
           class="nexus-filter-tab {% if tab == 'disputed' %}active{% endif %}">
          Disputed
        </a>
        <a href="/nexus/client/invoices?tab=overdue"
           class="nexus-filter-tab {% if tab == 'overdue' %}active{% endif %} {% if summary.overdueCount > 0 %}has-alert{% endif %}">
          Overdue
        </a>
        <a href="/nexus/client/invoices?tab=paid"
           class="nexus-filter-tab {% if tab == 'paid' %}active{% endif %}">
          Paid
        </a>
        <a href="/nexus/client/invoices?tab=all"
           class="nexus-filter-tab {% if tab == 'all' %}active{% endif %}">
          All
        </a>
      </div>
    </div>

    <!-- Filter Bar (C8.1) -->
    <form method="GET" action="/nexus/client/invoices" class="nexus-filterbar">
      <input type="hidden" name="tab" value="{{ tab }}" />
      <input class="nexus-input" name="q" value="{{ query.q or '' }}" placeholder="Search invoice ID..." style="width:160px;" />
      <input class="nexus-input" name="vendor_id" value="{{ query.vendor_id or '' }}" placeholder="Vendor ID" style="width:120px;" />
      <input class="nexus-input" type="date" name="from" value="{{ query.from or '' }}" title="From date" style="width:130px;" />
      <input class="nexus-input" type="date" name="to" value="{{ query.to or '' }}" title="To date" style="width:130px;" />
      <input class="nexus-input" type="number" name="min" value="{{ query.min or '' }}" placeholder="Min $" style="width:80px;" />
      <input class="nexus-input" type="number" name="max" value="{{ query.max or '' }}" placeholder="Max $" style="width:80px;" />
      <button class="nexus-btn small primary" type="submit">Apply</button>
      <a class="nexus-btn small muted" href="/nexus/client/invoices?tab={{ tab }}">Reset</a>
    </form>

    {% if invoices.length > 0 %}
    <div class="nexus-table-container">
      <table class="nexus-table">
        <thead>
          <tr>
            <th>Invoice</th>
            <th>Vendor</th>
            <th>Amount</th>
            <th>Outstanding</th>
            <th>Due Date</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for inv in invoices %}
          <tr class="nexus-table-row {% if inv.status == 'overdue' %}row-danger{% elif inv.status == 'disputed' %}row-warning{% endif %}">
            <td>
              <div class="nexus-cell-main">
                <span class="nexus-cell-id">{{ inv.invoice_id }}</span>
                {% if inv.invoice_number %}
                <span class="nexus-cell-sub">{{ inv.invoice_number }}</span>
                {% endif %}
              </div>
            </td>
            <td>
              <span class="nexus-cell-vendor">
                {{ inv.vendor_tenant.display_name or inv.vendor_tenant.name or inv.vendor_id }}
              </span>
            </td>
            <td>
              <span class="nexus-cell-amount">${{ inv.total_amount | round(2) }}</span>
            </td>
            <td>
              <span class="nexus-cell-amount {% if inv.amount_outstanding > 0 %}outstanding{% endif %}">
                ${{ inv.amount_outstanding | round(2) }}
              </span>
            </td>
            <td>
              <span class="nexus-cell-date {% if inv.status == 'overdue' %}overdue{% endif %}">
                {{ inv.due_date }}
              </span>
            </td>
            <td>
              <span class="nexus-badge {{ inv.status }}">{{ inv.status }}</span>
            </td>
            <td>
              <a href="/nexus/client/invoices/{{ inv.invoice_id }}" class="nexus-btn small secondary">
                View ‚Üí
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination (C8.1) -->
    {% if pagination.total > pagination.limit %}
    <div class="nexus-pagination">
      <div class="nexus-pagination-meta">
        Showing {{ pagination.fromRow }}‚Äì{{ pagination.toRow }} of {{ pagination.total }}
      </div>
      <div class="nexus-pagination-actions">
        {% if pagination.hasPrev %}
        <a class="nexus-btn small muted" href="/nexus/client/invoices?tab={{ tab }}&q={{ query.q or '' }}&vendor_id={{ query.vendor_id or '' }}&from={{ query.from or '' }}&to={{ query.to or '' }}&min={{ query.min or '' }}&max={{ query.max or '' }}&limit={{ pagination.limit }}&offset={{ pagination.prevOffset }}">
          ‚Üê Prev
        </a>
        {% endif %}
        {% if pagination.hasNext %}
        <a class="nexus-btn small muted" href="/nexus/client/invoices?tab={{ tab }}&q={{ query.q or '' }}&vendor_id={{ query.vendor_id or '' }}&from={{ query.from or '' }}&to={{ query.to or '' }}&min={{ query.min or '' }}&max={{ query.max or '' }}&limit={{ pagination.limit }}&offset={{ pagination.nextOffset }}">
          Next ‚Üí
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="nexus-empty-state-box">
      <div class="nexus-empty-state-icon">üìÑ</div>
      <h3>No invoices found</h3>
      {% if tab != 'all' %}
      <p>No invoices match the selected filter. <a href="/nexus/client/invoices?tab=all">View all invoices</a></p>
      {% else %}
      <p>You don't have any invoices to pay yet.</p>
      {% endif %}
    </div>
    {% endif %}
  </section>

  <!-- Quick Actions -->
  <section class="nexus-quick-actions">
    <a href="/nexus/client" class="nexus-btn secondary">
      ‚Üê Back to Dashboard
    </a>
    <a href="/nexus/client/payments" class="nexus-btn secondary">
      üí≥ View Payments ‚Üí
    </a>
  </section>

</div>
{% endblock %}
