{% extends "nexus/layout.html" %}

{% block title %}Payment {{ payment.payment_id }}{% endblock %}

{% set activeNav = 'client' %}

{% block content %}
<div class="nexus-page client-payment-detail">
  <!-- Breadcrumb -->
  <nav class="nexus-breadcrumb">
    <a href="/nexus/client">Dashboard</a>
    <span class="nexus-breadcrumb-sep">‚Üí</span>
    <a href="/nexus/client/payments">Payment Outbox</a>
    <span class="nexus-breadcrumb-sep">‚Üí</span>
    <span class="nexus-breadcrumb-current">{{ payment.payment_id }}</span>
  </nav>

  <!-- Document Header -->
  <header class="nexus-document-header">
    <div class="nexus-document-header-top">
      <span class="nexus-context-badge client">‚óÄ Client Mode</span>
      <span class="nexus-badge {{ payment.status }}">{{ payment.status }}</span>
    </div>
    <div class="nexus-document-header-main">
      <div class="nexus-document-identity">
        <h1 class="nexus-document-id">{{ payment.payment_id }}</h1>
        {% if payment.payment_reference %}
        <span class="nexus-document-ref">Ref: {{ payment.payment_reference }}</span>
        {% endif %}
      </div>
      <div class="nexus-document-vendor">
        <span class="nexus-document-vendor-label">To</span>
        <span class="nexus-document-vendor-name">
          {{ payment.to_tenant.display_name or payment.to_tenant.name or payment.to_id }}
        </span>
      </div>
    </div>
  </header>

  <!-- Financial Summary -->
  <section class="nexus-document-summary">
    <div class="nexus-document-amounts">
      <div class="nexus-document-amount-item primary">
        <span class="nexus-document-amount-label">Amount</span>
        <span class="nexus-document-amount-value">${{ payment.amount | round(2) }}</span>
      </div>
      <div class="nexus-document-amount-item">
        <span class="nexus-document-amount-label">Currency</span>
        <span class="nexus-document-amount-value currency">{{ payment.currency or 'USD' }}</span>
      </div>
      <div class="nexus-document-amount-item">
        <span class="nexus-document-amount-label">Method</span>
        <span class="nexus-document-amount-value method">{{ payment.payment_method or '‚Äî' }}</span>
      </div>
    </div>
    <div class="nexus-document-dates">
      {% if payment.payment_date %}
      <div class="nexus-document-date-item">
        <span class="nexus-document-date-label">Payment Date</span>
        <span class="nexus-document-date-value">{{ payment.payment_date }}</span>
      </div>
      {% endif %}
      {% if payment.scheduled_date and not payment.payment_date %}
      <div class="nexus-document-date-item">
        <span class="nexus-document-date-label">Scheduled Date</span>
        <span class="nexus-document-date-value">{{ payment.scheduled_date }}</span>
      </div>
      {% endif %}
      <div class="nexus-document-date-item">
        <span class="nexus-document-date-label">Created</span>
        <span class="nexus-document-date-value">{{ payment.created_at | truncate(10, true, '') }}</span>
      </div>
    </div>
  </section>

  <!-- Payment Details -->
  <section class="nexus-document-section">
    <h2>Payment Details</h2>
    <div class="nexus-detail-grid">
      <div class="nexus-detail-item">
        <span class="nexus-detail-label">Status</span>
        <span class="nexus-detail-value">
          <span class="nexus-badge {{ payment.status }}">{{ payment.status }}</span>
        </span>
      </div>
      <div class="nexus-detail-item">
        <span class="nexus-detail-label">Payment Method</span>
        <span class="nexus-detail-value">{{ payment.payment_method or 'Not specified' }}</span>
      </div>
      {% if payment.bank_account_last4 %}
      <div class="nexus-detail-item">
        <span class="nexus-detail-label">Account</span>
        <span class="nexus-detail-value">****{{ payment.bank_account_last4 }}</span>
      </div>
      {% endif %}
      <div class="nexus-detail-item">
        <span class="nexus-detail-label">Reconciled</span>
        <span class="nexus-detail-value">
          {% if payment.reconciled %}
          <span class="nexus-badge success">Yes</span>
          {% if payment.reconciled_at %}
          <span class="nexus-detail-sub">{{ payment.reconciled_at | truncate(10, true, '') }}</span>
          {% endif %}
          {% else %}
          <span class="nexus-badge muted">No</span>
          {% endif %}
        </span>
      </div>
    </div>
  </section>

  <!-- Linked Invoice -->
  <section class="nexus-document-section">
    <h2>Linked Invoice</h2>
    {% if linkedInvoice %}
    <div class="nexus-linked-document">
      <div class="nexus-linked-document-main">
        <div class="nexus-linked-document-identity">
          <span class="nexus-linked-document-id">{{ linkedInvoice.invoice_id }}</span>
          {% if linkedInvoice.invoice_number %}
          <span class="nexus-linked-document-ref">{{ linkedInvoice.invoice_number }}</span>
          {% endif %}
        </div>
        <div class="nexus-linked-document-meta">
          <span class="nexus-linked-document-amount">${{ linkedInvoice.total_amount | round(2) }}</span>
          <span class="nexus-badge {{ linkedInvoice.status }}">{{ linkedInvoice.status }}</span>
        </div>
      </div>
      <div class="nexus-linked-document-details">
        <span class="nexus-linked-document-detail">
          Due: {{ linkedInvoice.due_date }}
        </span>
        <span class="nexus-linked-document-detail">
          Outstanding: ${{ linkedInvoice.amount_outstanding | round(2) }}
        </span>
      </div>
      <div class="nexus-linked-document-actions">
        <a href="/nexus/client/invoices/{{ linkedInvoice.invoice_id }}" class="nexus-btn small secondary">
          View Invoice ‚Üí
        </a>
      </div>
    </div>
    {% else %}
    <div class="nexus-empty-state-inline">
      <p>This payment is not linked to a specific invoice.</p>
    </div>
    {% endif %}
  </section>

  <!-- Processing Timeline -->
  <section class="nexus-document-section">
    <h2>Processing Timeline</h2>
    <div class="nexus-status-timeline">
      {% for entry in statusHistory %}
      <div class="nexus-timeline-item">
        <span class="nexus-timeline-dot {{ entry.status }}"></span>
        <div class="nexus-timeline-content">
          <span class="nexus-timeline-status">{{ entry.status | capitalize }}</span>
          <span class="nexus-timeline-date">{{ entry.timestamp | truncate(19, true, '') }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- Notes/Description -->
  {% if payment.description or payment.notes %}
  <section class="nexus-document-section">
    <h2>Notes</h2>
    <div class="nexus-document-notes">
      {% if payment.description %}
      <p>{{ payment.description }}</p>
      {% endif %}
      {% if payment.notes %}
      <p class="nexus-document-notes-secondary">{{ payment.notes }}</p>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Approval Workflow (CCP-C9) -->
  {% if workflowState %}
  <section class="nexus-document-section">
    <h2>Approval Workflow</h2>
    <div class="nexus-workflow-state">
      <div class="nexus-workflow-current">
        <span class="nexus-badge {{ workflowState }}">{{ workflowState | replace('_', ' ') | title }}</span>
        {% if approvalRules.threshold_amount %}
        <span class="nexus-workflow-meta">Threshold: ${{ approvalRules.threshold_amount | round(2) }}</span>
        {% endif %}
        {% if approvalRules.requires_dual_control %}
        <span class="nexus-workflow-meta">Dual Control: Required</span>
        {% endif %}
      </div>

      {% if approvals.length > 0 %}
      <div class="nexus-approval-queue" style="margin-top:16px;">
        <h3 style="font-size:14px; font-weight:600; margin-bottom:8px;">Approvals</h3>
        <div class="nexus-approval-list">
          {% for approval in approvals %}
          <div class="nexus-approval-item">
            <span class="nexus-badge success">‚úÖ Approved</span>
            <span class="nexus-approval-meta">{{ approval.timestamp | truncate(10, true, '') }}</span>
            {% if approval.approver_id %}
            <span class="nexus-approval-meta">by {{ approval.approver_id }}</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% if approvalHistory.length > 0 %}
      <div class="nexus-workflow-history" style="margin-top:16px;">
        <h3 style="font-size:14px; font-weight:600; margin-bottom:8px;">State History</h3>
        <div class="nexus-status-timeline">
          {% for entry in approvalHistory %}
          <div class="nexus-timeline-item">
            <span class="nexus-timeline-dot {{ entry.state }}"></span>
            <div class="nexus-timeline-content">
              <span class="nexus-timeline-status">{{ entry.state | replace('_', ' ') | title }}</span>
              <span class="nexus-timeline-date">{{ entry.timestamp | truncate(19, true, '') }}</span>
              {% if entry.action %}
              <span class="nexus-timeline-action">{{ entry.action | title }}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Navigation + Decision Actions -->
  <section class="nexus-document-actions">
    <a href="/nexus/client/payments" class="nexus-btn secondary">
      ‚Üê Back to Payment Outbox
    </a>
    <a href="/nexus/client/invoices" class="nexus-btn secondary">
      üìÑ View All Invoices
    </a>

    {% if workflowState == 'pending_approval' or payment.status == 'pending' %}
    <!-- Payment Decision Block (CCP-C9 Enhanced) -->
    <div class="nexus-payment-decision">
      <!-- Approve Button -->
      <form method="POST" action="/nexus/client/payments/{{ payment.payment_id }}/approve" style="display:inline;">
        <button class="nexus-btn primary" type="submit">
          ‚úÖ Approve for Payment
        </button>
      </form>

      <!-- Reject Button -->
      <details class="nexus-reject-details" style="display:inline-block; margin-left:8px;">
        <summary class="nexus-btn warning" role="button" aria-label="Reject payment">
          ‚ùå Reject
        </summary>
        <form method="POST" action="/nexus/client/payments/{{ payment.payment_id }}/reject" class="nexus-reject-form" style="margin-top:8px; padding:12px; border:1px solid #ddd; border-radius:4px;">
          <label class="nexus-label">
            Reason
            <textarea name="reason" class="nexus-textarea" rows="2" placeholder="Reason for rejection..." required></textarea>
          </label>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="nexus-btn warning small" type="submit">Reject Payment</button>
            <button class="nexus-btn muted small" type="button" onclick="this.closest('details').removeAttribute('open')">Cancel</button>
          </div>
        </form>
      </details>

      <!-- Raise Issue (Dispute) -->
      <details class="nexus-dispute-details" style="display:inline-block; margin-left:8px;">
        <summary class="nexus-btn danger" role="button" aria-label="Raise issue (dispute payment)">
          üö® Raise Issue
        </summary>

        <form method="POST" action="/nexus/client/payments/{{ payment.payment_id }}/dispute" class="nexus-dispute-form">
          <label class="nexus-label">
            Subject
            <input name="subject" class="nexus-input" placeholder="e.g., Amount incorrect / Wrong vendor / Duplicate payment" required />
          </label>

          <label class="nexus-label" style="margin-top:8px;">
            Description
            <textarea name="description" class="nexus-textarea" rows="3" placeholder="Describe the issue in detail..."></textarea>
          </label>

          <div style="margin-top:12px; display:flex; gap:8px;">
            <button class="nexus-btn danger small" type="submit">Submit Dispute</button>
            <button class="nexus-btn muted small" type="button" onclick="this.closest('details').removeAttribute('open')">Cancel</button>
          </div>
        </form>
      </details>
    </div>
    {% elif workflowState == 'approved' or payment.status == 'approved' %}
    <div class="nexus-payment-approved-badge">
      <span class="nexus-badge success">‚úÖ Approved</span>
      {% if payment.approved_at %}
      <span class="nexus-approved-meta">on {{ payment.approved_at | truncate(10, true, '') }}</span>
      {% endif %}
      <!-- Release Button -->
      <form method="POST" action="/nexus/client/payments/{{ payment.payment_id }}/release" style="display:inline; margin-left:8px;">
        <button class="nexus-btn primary small" type="submit">
          üöÄ Release Payment
        </button>
      </form>
    </div>
    {% elif workflowState == 'rejected' %}
    <div class="nexus-payment-rejected-badge">
      <span class="nexus-badge warning">‚ùå Rejected</span>
      {% if workflow.approval_workflow.rejection_reason %}
      <span class="nexus-rejection-reason" style="margin-left:8px;">{{ workflow.approval_workflow.rejection_reason }}</span>
      {% endif %}
    </div>
    {% elif payment.status == 'disputed' %}
    <div class="nexus-payment-disputed-badge">
      <span class="nexus-badge danger">üö® Disputed</span>
      {% if payment.case_id %}
      <a href="/nexus/client/cases/{{ payment.case_id }}" class="nexus-btn warning small" style="margin-left:8px;">
        View Dispute Case ‚Üí
      </a>
      {% endif %}
    </div>
    {% endif %}
  </section>

</div>
{% endblock %}
