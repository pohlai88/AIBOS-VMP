{% extends "nexus/layout.html" %}

{% block title %}Reset Password{% endblock %}

{% block content %}
<div class="nexus-auth-page">
  <div class="nexus-auth-card">
    <div class="nexus-auth-header">
      <span class="nexus-logo-icon large">⬡</span>
      <h1>Set New Password</h1>
      {% if email %}
      <p>Enter a new password for <strong>{{ email }}</strong></p>
      {% else %}
      <p>Enter your new password</p>
      {% endif %}
    </div>

    {% if error %}
    <div class="nexus-alert error">
      <span class="nexus-alert-icon">✕</span>
      <div>
        <strong>Unable to reset password</strong>
        <p>{{ error }}</p>
      </div>
    </div>
    <div class="nexus-auth-footer">
      <p><a href="/nexus/forgot-password">Request a new reset link</a></p>
      <p><a href="/nexus/login">← Back to login</a></p>
    </div>
    {% else %}
    <form class="nexus-auth-form" id="reset-password-form">
      <input type="hidden" name="accessToken" value="{{ accessToken }}">

      <div class="nexus-form-group">
        <label for="password">New Password</label>
        <input
          type="password"
          id="password"
          name="password"
          required
          minlength="8"
          autocomplete="new-password"
          placeholder="••••••••"
        >
        <small class="nexus-form-hint">At least 8 characters</small>
      </div>

      <div class="nexus-form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input
          type="password"
          id="confirmPassword"
          name="confirmPassword"
          required
          minlength="8"
          autocomplete="new-password"
          placeholder="••••••••"
        >
      </div>

      <div id="form-error" class="nexus-form-error hidden"></div>

      <button type="submit" class="nexus-btn primary full-width">
        Update Password
      </button>
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('reset-password-form')?.addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.target;
  const errorDiv = document.getElementById('form-error');
  const submitBtn = form.querySelector('button[type="submit"]');

  const password = form.password.value;
  const confirmPassword = form.confirmPassword.value;

  if (password !== confirmPassword) {
    errorDiv.textContent = 'Passwords do not match';
    errorDiv.classList.remove('hidden');
    return;
  }

  if (password.length < 8) {
    errorDiv.textContent = 'Password must be at least 8 characters';
    errorDiv.classList.remove('hidden');
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="nexus-spinner"></span> Updating...';
  errorDiv.classList.add('hidden');

  try {
    const response = await fetch('/nexus/reset-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Accept: 'application/json',
      },
      body: JSON.stringify({
        accessToken: form.accessToken.value,
        password: password,
      }),
    });

    const data = await response.json();

    if (response.ok && data.success) {
      // Show success message and redirect
      submitBtn.innerHTML = '✓ Password Updated';
      submitBtn.classList.add('success');
      setTimeout(() => {
        window.location.href = data.redirect || '/nexus/login?reset=success';
      }, 1500);
    } else {
      errorDiv.textContent = data.error || 'Failed to update password';
      errorDiv.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Update Password';
    }
  } catch (err) {
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.classList.remove('hidden');
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Update Password';
  }
});
</script>
{% endblock %}
