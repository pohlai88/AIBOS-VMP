{% extends "layout.html" %}
{% block title %}Vendor Management — NexusCanon{% endblock %}

{% block head %}
  <link rel="stylesheet" href="/vmp-vendors.lux.css">
{% endblock %}

{% block content %}
<div class="vmp-container vmp-vendors">

  <!-- Header -->
  <div class="vmp-vendors-header">
    <div class="vmp-vendors-title">
      <h1 class="vmp-h1">Vendor Management</h1>
      <p class="vmp-subtitle">Search, filter, and maintain vendor profiles in a controlled ledger scope.</p>
    </div>

    <div class="vmp-vendors-cta">
      <a class="vmp-btn vmp-btn-primary" href="/vendors/new" aria-label="Create vendor">
        Create Vendor
      </a>
    </div>
  </div>

  <div class="vmp-card">
    {% if vendors and vendors|length > 0 %}

      <!-- Command Bar -->
      <div class="vmp-toolbar" role="region" aria-label="Vendor filters">
        <div class="vmp-toolbar__left">
          <div class="vmp-field vmp-field--grow">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                    d="M21 21l-4.35-4.35m1.85-5.15a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input
              id="vendorSearch"
              class="vmp-input"
              type="search"
              inputmode="search"
              autocomplete="off"
              placeholder="Search vendor, code, email, phone… (press /)"
              aria-label="Search vendors"
            />
          </div>

          <div class="vmp-field">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M3 5h18M6 12h12M10 19h4"/>
            </svg>
            <select id="vendorStatus" class="vmp-select" aria-label="Filter by status">
              <option value="">All status</option>
              <option value="active">Active</option>
              <option value="pending">Pending</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>

          <button type="button" id="vendorClear" class="vmp-btn vmp-btn-ghost" aria-label="Clear filters">
            Clear
          </button>
        </div>

        <div class="vmp-toolbar__right">
          <span id="vendorCount" class="vmp-kpi text-mono" aria-live="polite"></span>
        </div>
      </div>

      <div class="vmp-table-wrap">
        <table class="vmp-table" aria-label="Vendors table">
          <thead>
            <tr>
              <th class="vmp-th">Vendor</th>
              <th class="vmp-th">Code</th>
              <th class="vmp-th">Contact</th>
              <th class="vmp-th">Details</th>
              <th class="vmp-th">Status</th>
              <th class="vmp-th">Created</th>
              <th class="vmp-th" style="text-align:right;">Actions</th>
            </tr>
          </thead>

          <tbody id="vendorTableBody">
            {% for vendor in vendors %}
              <tr
                class="vmp-row"
                tabindex="0"
                data-vmp-vendor-row
                data-status="{{ (vendor.status or '')|lower|e }}"
                data-search="{{ (vendor.name ~ ' ' ~ vendor.code ~ ' ' ~ (vendor.contact_email or '') ~ ' ' ~ (vendor.contact_phone or '') ~ ' ' ~ (vendor.address or ''))|lower|e }}"
              >
                <td class="vmp-td" style="font-weight: 650;">{{ vendor.name }}</td>
                <td class="vmp-td text-mono text-subtle">{{ vendor.code }}</td>

                <td class="vmp-td">
                  {% if vendor.contact_email %}
                    <a href="mailto:{{ vendor.contact_email }}">{{ vendor.contact_email }}</a>
                  {% endif %}
                  {% if vendor.contact_phone %}
                    <div class="text-subtle" style="margin-top: 6px; font-size: 12px;">{{ vendor.contact_phone }}</div>
                  {% endif %}
                </td>

                <td class="vmp-td">{{ vendor.address or '' }}</td>

                <td class="vmp-td">
                  {% if vendor.status == 'active' %}
                    <span class="vmp-pill vmp-badge-ok" aria-label="Active">Active</span>
                  {% elif vendor.status == 'pending' %}
                    <span class="vmp-pill vmp-badge-warn" aria-label="Pending">Pending</span>
                  {% elif vendor.status == 'suspended' %}
                    <span class="vmp-pill vmp-badge-danger" aria-label="Suspended">Suspended</span>
                  {% else %}
                    <span class="text-subtle">{{ vendor.status|capitalize }}</span>
                  {% endif %}
                </td>

                <td class="vmp-td text-subtle" style="font-size: 12px;">
                  {{ vendor.created_at.split('T')[0] if vendor.created_at else 'N/A' }}
                </td>

                <td class="vmp-td" style="text-align:right;">
                  <div class="vmp-actions">
                    <button
                      class="vmp-btn"
                      data-action="edit"
                      hx-get="/api/vendors/{{ vendor.id }}/edit-modal"
                      hx-target="#modal-container"
                      title="Edit vendor"
                      aria-label="Edit vendor"
                      type="button"
                    >
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                    </button>

                    <button
                      class="vmp-btn"
                      style="color: var(--vmp-danger); border-color: color-mix(in srgb, var(--vmp-danger) 60%, var(--vmp-border));"
                      data-action="delete"
                      hx-get="/api/vendors/{{ vendor.id }}/delete-modal"
                      hx-target="#modal-container"
                      title="Delete vendor"
                      aria-label="Delete vendor"
                      type="button"
                    >
                      <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}

      <div class="vmp-empty">
        <div class="vmp-empty__icon" aria-hidden="true">
          <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
        </div>
        <h3 class="vmp-empty__title">No vendors yet</h3>
        <p class="vmp-empty__desc">Create your first vendor profile to start dispute-free settlement workflows.</p>
        <a class="vmp-btn vmp-btn-primary" href="/vendors/new">Create Vendor</a>
      </div>

    {% endif %}
  </div>
</div>

<div id="modal-container"></div>

<script>
(function () {
  const searchEl = document.getElementById('vendorSearch');
  const statusEl = document.getElementById('vendorStatus');
  const clearEl  = document.getElementById('vendorClear');
  const countEl  = document.getElementById('vendorCount');
  const rows     = Array.from(document.querySelectorAll('[data-vmp-vendor-row]'));

  if (!searchEl || !statusEl || !clearEl || !countEl) return;

  const norm = v => (v || '').toString().trim().toLowerCase();

  const render = () => {
    const q  = norm(searchEl.value);
    const st = norm(statusEl.value);

    let visible = 0;

    for (const row of rows) {
      const rowSearch = norm(row.dataset.search);
      const rowStatus = norm(row.dataset.status);

      const matchQ = !q  || rowSearch.includes(q);
      const matchS = !st || rowStatus === st;

      const show = matchQ && matchS;
      row.style.display = show ? '' : 'none';
      if (show) visible += 1;
    }

    countEl.textContent = `${visible} / ${rows.length} vendors`;
  };

  searchEl.addEventListener('input', render);
  statusEl.addEventListener('change', render);

  clearEl.addEventListener('click', () => {
    searchEl.value = '';
    statusEl.value = '';
    render();
    searchEl.focus();
  });

  document.addEventListener('keydown', e => {
    const tag = (document.activeElement && document.activeElement.tagName || '').toLowerCase();
    const typing = tag === 'input' || tag === 'textarea' || tag === 'select';
    if (e.key === '/' && !typing) { e.preventDefault(); searchEl.focus(); }
    if (e.key === 'Escape' && document.activeElement === searchEl) searchEl.blur();
  });

  render();
})();
</script>
{% endblock %}
