<!-- Escalation Cell - Displays escalation hierarchy and contact information (Sprint 8) -->
<div class="vmp-escalation-zone">
    <div class="vmp-label-kicker vmp-label-kicker-strong mb-4">ESCALATION PATH</div>

    <div class="space-y-4">
        <!-- Level 1: AI Assistant -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 1: AI Assistant</div>
                <span class="vmp-badge vmp-badge-ok text-xs">ACTIVE</span>
            </div>
            <div class="vmp-caption vmp-muted">
                Automated case resolution and evidence verification.
            </div>
        </div>

        <!-- Level 2: AP Manager -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 2: AP Manager</div>
                {% if caseDetail and caseDetail.escalation_level >= 2 %}
                <span class="vmp-badge vmp-badge-warn text-xs">ESCALATED</span>
                {% else %}
                <span class="vmp-badge text-xs">ON CALL</span>
                {% endif %}
            </div>
            <div class="vmp-caption vmp-muted mb-2">
                For complex cases requiring human review.
            </div>
            
            <!-- Sprint 8.4: AP Manager Contact Information (Internal Only - Privacy Shield) -->
            {% if isInternal and caseDetail and caseDetail.assigned_user %}
            <div class="mt-3 p-2 rounded border vmp-border-color vmp-bg-veil">
                <div class="vmp-label-kicker mb-2">ASSIGNED AP MANAGER</div>
                <div class="space-y-1.5">
                    <div class="vmp-body-small">
                        <span class="vmp-label">Name:</span> {{ caseDetail.assigned_user.display_name or caseDetail.assigned_user.email }}
                    </div>
                    {% if caseDetail.assigned_user.email %}
                    <div class="vmp-body-small">
                        <span class="vmp-label">Email:</span> 
                        <a href="mailto:{{ caseDetail.assigned_user.email }}?subject=Case {{ caseId|string|truncate(8, True, '') }} - {{ caseDetail.subject if caseDetail else 'Inquiry' }}" 
                           class="vmp-link">{{ caseDetail.assigned_user.email }}</a>
                    </div>
                    {% endif %}
                </div>
                <!-- Sprint 8.4: Contact AP Manager Button -->
                <div class="mt-3">
                    <a href="mailto:{{ caseDetail.assigned_user.email }}?subject=Case {{ caseId|string|truncate(8, True, '') }} - {{ caseDetail.subject if caseDetail else 'Inquiry' }}&body=Hello,%0D%0A%0D%0AI would like to discuss Case {{ caseId|string|truncate(8, True, '') }}: {{ caseDetail.subject if caseDetail else 'Inquiry' }}.%0D%0A%0D%0AThank you." 
                       class="inline-block px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-primary text-sm">
                        Contact AP Manager
                    </a>
                </div>
            </div>
            {% elif not isInternal and caseDetail and caseDetail.owner_team %}
            <!-- Supplier View: Show generic team name only (Privacy Shield) -->
            <div class="mt-2 vmp-caption font-mono vmp-subtle">
                Owner Team: {{ caseDetail.owner_team | upper }}
            </div>
            {% elif caseDetail and caseDetail.owner_team %}
            <div class="mt-2 vmp-caption font-mono vmp-subtle">
                Owner Team: {{ caseDetail.owner_team | upper }}
            </div>
            {% endif %}
            
            <!-- Sprint 8.4: Response Time SLA -->
            {% if caseDetail and caseDetail.sla_due_at %}
            <div class="mt-3 p-2 rounded border vmp-border-color vmp-bg-veil">
                <div class="vmp-label-kicker mb-1">RESPONSE TIME SLA</div>
                <div class="vmp-body-small">
                    {% set slaDate = caseDetail.sla_due_at | date('%Y-%m-%d') %}
                    {% set today = 'now' | date('%Y-%m-%d') %}
                    {% if slaDate < today %}
                        <span class="vmp-text-danger">Overdue: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% elif slaDate == today %}
                        <span class="vmp-text-warn">Due today: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% else %}
                        <span class="vmp-text-ok">Due: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% endif %}
                </div>
                <div class="vmp-caption vmp-muted mt-1">
                    Expected response within 2 business days
                </div>
            </div>
            {% endif %}
            
            {% if caseDetail and caseDetail.escalation_level < 2 %}
            <form hx-post="/cases/{{ caseId }}/escalate" 
                  hx-target="#case-escalation-container" 
                  hx-swap="innerHTML"
                  class="mt-3">
                <input type="hidden" name="escalation_level" value="2">
                <button type="submit" 
                        class="px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-ghost vmp-bg-veil vmp-border-color hover:vmp-bg-panel text-sm">
                    ESCALATE TO AP MANAGER
                </button>
            </form>
            {% endif %}
        </div>

        <!-- Level 3: Break-glass Contact -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel"
             x-data="{ showConfirm: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 3: Break-glass</div>
                <span class="vmp-badge vmp-badge-warn text-xs">EMERGENCY</span>
            </div>
            <div class="vmp-caption vmp-muted">
                Critical escalation for urgent payment or compliance issues.
            </div>
            {% if caseDetail and caseDetail.escalation_level >= 3 %}
            <div class="mt-2 vmp-caption vmp-signal-warn">
                ⚠️ Escalated to Level 3 (Break-glass)
            </div>
            <!-- Emergency Contact Card (Break Glass Protocol) -->
            {% if directorInfo %}
            <div class="vmp-emergency-contact">
                <div class="vmp-emergency-contact-header">EMERGENCY CONTACT</div>
                <div class="vmp-emergency-contact-item">
                    <span class="vmp-emergency-contact-label">Director:</span>
                    <span>{{ directorInfo.director_name }}</span>
                </div>
                <div class="vmp-emergency-contact-item">
                    <span class="vmp-emergency-contact-label">Phone:</span>
                    <a href="tel:{{ directorInfo.director_phone }}" class="vmp-link">{{ directorInfo.director_phone }}</a>
                </div>
                <div class="vmp-emergency-contact-item">
                    <span class="vmp-emergency-contact-label">Email:</span>
                    <a href="mailto:{{ directorInfo.director_email }}" class="vmp-link">{{ directorInfo.director_email }}</a>
                </div>
            </div>
            {% endif %}
            {% else %}
            <!-- Confirmation Dialog -->
            <div x-show="showConfirm" 
                 x-transition
                 class="mt-3 p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-20">
                <div class="vmp-label vmp-text-warn mb-2">⚠️ Confirm Break Glass Escalation</div>
                <div class="vmp-caption vmp-muted mb-3">
                    This will log an incident with the Group Director. This action is reserved for critical payment or compliance issues.
                </div>
                <div class="flex gap-2">
                    <form hx-post="/cases/{{ caseId }}/escalate" 
                          hx-target="#case-escalation-container" 
                          hx-swap="innerHTML"
                          class="inline">
                        <input type="hidden" name="escalation_level" value="3">
                        <button type="submit" 
                                class="px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-ghost vmp-bg-veil vmp-border-warn hover:vmp-bg-warn text-sm vmp-text-warn">
                            CONFIRM ESCALATION
                        </button>
                    </form>
                    <button type="button"
                            @click="showConfirm = false"
                            class="px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-ghost vmp-bg-veil vmp-border-color hover:vmp-bg-panel text-sm">
                        CANCEL
                    </button>
                </div>
            </div>
            <!-- Initial Request Button -->
            <div x-show="!showConfirm" class="mt-2">
                <button type="button"
                        @click="showConfirm = true"
                        class="vmp-break-glass">
                    REQUEST ESCALATION
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Escalation Status -->
    {% if caseDetail and caseDetail.escalation_level > 0 %}
    <div class="mt-4 p-3 rounded-lg border 
        {% if caseDetail.escalation_level >= 3 %}vmp-border-warn vmp-bg-warn vmp-opacity-30
        {% elif caseDetail.escalation_level >= 2 %}vmp-border-warn vmp-bg-warn vmp-opacity-20
        {% else %}vmp-border-color vmp-bg-panel{% endif %}">
        <div class="vmp-label 
            {% if caseDetail.escalation_level >= 3 %}vmp-text-warn
            {% elif caseDetail.escalation_level >= 2 %}vmp-text-warn
            {% endif %} mb-1">
            {% if caseDetail.escalation_level >= 3 %}
            Case Escalated to Level 3 (Break-glass)
            {% elif caseDetail.escalation_level >= 2 %}
            Case Escalated to Level 2 (AP Manager)
            {% else %}
            Case Escalated to Level 1
            {% endif %}
        </div>
        <div class="vmp-caption vmp-muted">
            {% if caseDetail.escalation_level >= 3 %}
            Critical escalation active. AP Manager and break-glass contacts have been notified.
            {% elif caseDetail.escalation_level >= 2 %}
            Case has been escalated to AP Manager for review.
            {% else %}
            Case is being handled by AI Assistant.
            {% endif %}
        </div>
    </div>
    {% elif caseDetail and caseDetail.status == 'blocked' %}
    <div class="mt-4 p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-30">
        <div class="vmp-label vmp-text-warn mb-1">Case Blocked</div>
        <div class="vmp-caption vmp-muted">
            This case requires escalation. Contact your AP manager or use the break-glass option above.
        </div>
    </div>
    {% endif %}
</div>

