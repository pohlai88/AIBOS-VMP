<!-- Escalation Zone - Break-glass safety valve with audit trail (Wireframe Pattern) -->
<div class="vmp-escalation-zone">
    <div class="vmp-label-kicker vmp-label-kicker-strong mb-4 flex items-center gap-2">
        <span>‚ö†Ô∏è</span>
        <span>ESCALATION ZONE</span>
    </div>

    <div class="space-y-4">
        <!-- Level 1: AI Assistant -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 1: AI Assistant</div>
                <span class="vmp-badge vmp-badge-ok text-xs">ACTIVE</span>
            </div>
            <div class="vmp-caption vmp-muted">
                Automated case resolution and evidence verification.
            </div>
        </div>

        <!-- Level 2: AP Manager -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 2: AP Manager</div>
                {% if caseDetail and caseDetail.escalation_level >= 2 %}
                <span class="vmp-badge vmp-badge-warn text-xs">ESCALATED</span>
                {% else %}
                <span class="vmp-badge text-xs">ON CALL</span>
                {% endif %}
            </div>
            <div class="vmp-caption vmp-muted mb-2">
                For complex cases requiring human review.
            </div>
            
            <!-- Sprint 8.4: AP Manager Contact Information (Internal Only - Privacy Shield) -->
            {% if isInternal and caseDetail and caseDetail.assigned_user %}
            <div class="mt-3 p-2 rounded border vmp-border-color vmp-bg-veil">
                <div class="vmp-label-kicker mb-2">ASSIGNED AP MANAGER</div>
                <div class="space-y-1.5">
                    <div class="vmp-body-small">
                        <span class="vmp-label">Name:</span> {{ caseDetail.assigned_user.display_name or caseDetail.assigned_user.email }}
                    </div>
                    {% if caseDetail.assigned_user.email %}
                    <div class="vmp-body-small">
                        <span class="vmp-label">Email:</span> 
                        <a href="mailto:{{ caseDetail.assigned_user.email }}?subject=Case {{ caseId|string|truncate(8, True, '') }} - {{ caseDetail.subject if caseDetail else 'Inquiry' }}" 
                           class="vmp-link">{{ caseDetail.assigned_user.email }}</a>
                    </div>
                    {% endif %}
                </div>
                <!-- Sprint 8.4: Contact AP Manager Button -->
                <div class="mt-3">
                    <a href="mailto:{{ caseDetail.assigned_user.email }}?subject=Case {{ caseId|string|truncate(8, True, '') }} - {{ caseDetail.subject if caseDetail else 'Inquiry' }}&body=Hello,%0D%0A%0D%0AI would like to discuss Case {{ caseId|string|truncate(8, True, '') }}: {{ caseDetail.subject if caseDetail else 'Inquiry' }}.%0D%0A%0D%0AThank you." 
                       class="inline-block px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-primary text-sm">
                        Contact AP Manager
                    </a>
                </div>
            </div>
            {% elif not isInternal and caseDetail and caseDetail.owner_team %}
            <!-- Supplier View: Show generic team name only (Privacy Shield) -->
            <div class="mt-2 vmp-caption font-mono vmp-subtle">
                Owner Team: {{ caseDetail.owner_team | upper }}
            </div>
            {% elif caseDetail and caseDetail.owner_team %}
            <div class="mt-2 vmp-caption font-mono vmp-subtle">
                Owner Team: {{ caseDetail.owner_team | upper }}
            </div>
            {% endif %}
            
            <!-- Sprint 8.4: Response Time SLA -->
            {% if caseDetail and caseDetail.sla_due_at %}
            <div class="mt-3 p-2 rounded border vmp-border-color vmp-bg-veil">
                <div class="vmp-label-kicker mb-1">RESPONSE TIME SLA</div>
                <div class="vmp-body-small">
                    {% set slaDate = caseDetail.sla_due_at | date('%Y-%m-%d') %}
                    {% set today = 'now' | date('%Y-%m-%d') %}
                    {% if slaDate < today %}
                        <span class="vmp-text-danger">Overdue: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% elif slaDate == today %}
                        <span class="vmp-text-warn">Due today: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% else %}
                        <span class="vmp-text-ok">Due: {{ caseDetail.sla_due_at | date('%b %d, %Y') }}</span>
                    {% endif %}
                </div>
                <div class="vmp-caption vmp-muted mt-1">
                    Expected response within 2 business days
                </div>
            </div>
            {% endif %}
            
            {% if caseDetail and caseDetail.escalation_level < 2 %}
            <form hx-post="/cases/{{ caseId }}/escalate" 
                  hx-target="#case-escalation-container" 
                  hx-swap="innerHTML"
                  class="mt-3">
                <input type="hidden" name="escalation_level" value="2">
                <button type="submit" 
                        class="px-3 py-1.5 rounded transition-colors border vmp-action-button vmp-action-button-ghost vmp-bg-veil vmp-border-color hover:vmp-bg-panel text-sm">
                    ESCALATE TO AP MANAGER
                </button>
            </form>
            {% endif %}
        </div>

        <!-- Level 3: Break-glass Contact (Always Available - Wireframe Pattern) -->
        <div class="p-3 rounded-lg border vmp-border-color vmp-bg-panel"
             x-data="{ glassBroken: {{ 'true' if (caseDetail and caseDetail.escalation_level >= 3) else 'false' }} }">
            <div class="flex items-center justify-between mb-2">
                <div class="vmp-label">Level 3: Break-glass</div>
                <span class="vmp-badge vmp-badge-warn text-xs">EMERGENCY</span>
            </div>
            <div class="vmp-caption vmp-muted mb-4">
                Critical escalation for urgent payment or compliance issues. Always available.
            </div>
            
            {% if directorInfo %}
            <!-- Emergency Contact - Always Visible (Wireframe Pattern) -->
            <div class="vmp-emergency-contact mt-4 p-4 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-10">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-lg">üìû</span>
                    <span class="vmp-body font-medium">{{ directorInfo.director_name or 'Director' }}</span>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">üìß</span>
                    <a href="mailto:{{ directorInfo.director_email }}?subject=Case {{ caseId|string|truncate(8, True, '') }} - {{ caseDetail.subject if caseDetail else 'Urgent Review' }}&body=Hello,%0D%0A%0D%0AI need urgent management review for Case {{ caseId|string|truncate(8, True, '') }}: {{ caseDetail.subject if caseDetail else 'Urgent Review' }}.%0D%0A%0D%0AThank you." 
                       class="vmp-link">{{ directorInfo.director_email }}</a>
                </div>
                {% if caseDetail and caseDetail.escalation_level >= 3 %}
                <div class="mt-3 pt-3 border-t" style="border-color: var(--vmp-border);">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">üî¥</span>
                        <span class="vmp-label vmp-text-warn font-medium">GLASS BROKEN - Logged</span>
                    </div>
                    <div class="vmp-caption vmp-muted mt-1">
                        Escalation logged at {{ caseDetail.updated_at | date('%Y-%m-%d %H:%M') if caseDetail.updated_at else 'recently' }}
                    </div>
                </div>
                {% else %}
                <div class="mt-3 pt-3 border-t" style="border-color: var(--vmp-border);">
                    <div class="vmp-caption vmp-muted">
                        Contact information available. Escalation will be logged when you reach out.
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <!-- Fallback: Direct Break-glass Button (Always Available) -->
            <form hx-post="/cases/{{ caseId }}/escalate" 
                  hx-target="#case-escalation-container" 
                  hx-swap="innerHTML"
                  class="mt-4">
                <input type="hidden" name="escalation_level" value="3">
                <button type="submit" 
                        class="vmp-break-glass w-full">
                    Request Management Review
                </button>
                <div class="vmp-caption vmp-muted mt-2 text-center">
                    This will immediately log an escalation and notify management.
                </div>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Escalation Status -->
    {% if caseDetail and caseDetail.escalation_level > 0 %}
    <div class="mt-4 p-3 rounded-lg border 
        {% if caseDetail.escalation_level >= 3 %}vmp-border-warn vmp-bg-warn vmp-opacity-30
        {% elif caseDetail.escalation_level >= 2 %}vmp-border-warn vmp-bg-warn vmp-opacity-20
        {% else %}vmp-border-color vmp-bg-panel{% endif %}">
        <div class="vmp-label 
            {% if caseDetail.escalation_level >= 3 %}vmp-text-warn
            {% elif caseDetail.escalation_level >= 2 %}vmp-text-warn
            {% endif %} mb-1">
            {% if caseDetail.escalation_level >= 3 %}
            Case Escalated to Level 3 (Break-glass)
            {% elif caseDetail.escalation_level >= 2 %}
            Case Escalated to Level 2 (AP Manager)
            {% else %}
            Case Escalated to Level 1
            {% endif %}
        </div>
        <div class="vmp-caption vmp-muted">
            {% if caseDetail.escalation_level >= 3 %}
            Critical escalation active. AP Manager and break-glass contacts have been notified.
            {% elif caseDetail.escalation_level >= 2 %}
            Case has been escalated to AP Manager for review.
            {% else %}
            Case is being handled by AI Assistant.
            {% endif %}
        </div>
    </div>
    {% elif caseDetail and caseDetail.status == 'blocked' %}
    <div class="mt-4 p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-30">
        <div class="vmp-label vmp-text-warn mb-1">Case Blocked</div>
        <div class="vmp-caption vmp-muted">
            This case requires escalation. Contact your AP manager or use the break-glass option above.
        </div>
    </div>
    {% endif %}
</div>

