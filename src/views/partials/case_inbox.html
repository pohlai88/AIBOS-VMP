<div class="flex flex-col h-full" data-list-type="cases">
    {% if error %}
    <div class="p-3 m-4 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-30">
        <div class="vmp-caption vmp-text-warn">{{ error }}</div>
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar (Sprint 11.1) -->
    {% include "partials/bulk_actions_bar.html" %}
    
    <div class="sticky top-0 z-10 vmp-component-card-header backdrop-blur-md flex gap-2 overflow-x-auto py-3">
        <div class="flex gap-2 flex-1">
            <button class="vmp-tag vmp-tag-mono hover:bg-white/5 transition-colors vmp-navigation-link-active">
                ALL ({{ cases|length }})
            </button>
            <button class="vmp-tag vmp-tag-mono opacity-60 hover:opacity-100 hover:bg-white/5 transition-opacity">
                ACTION (2)
            </button>
            <button class="vmp-tag vmp-tag-mono opacity-60 hover:opacity-100 hover:bg-white/5 transition-opacity">
                WAITING (5)
            </button>
        </div>
        
        <!-- Export Button (Sprint 11.2) -->
        <div class="relative" x-data="{ open: false }">
            <button 
                @click="open = !open"
                class="vmp-btn vmp-btn-ghost text-sm flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export
            </button>
            
            <div 
                x-show="open"
                @click.away="open = false"
                class="absolute right-0 mt-2 w-48 vmp-panel border vmp-border-color rounded-lg shadow-lg z-30"
                style="display: none;">
                <div class="py-1">
                    <a 
                        href="/api/export/cases?format=excel"
                        class="block w-full text-left px-4 py-2 vmp-body-small hover:vmp-bg-veil transition-colors">
                        Export to Excel
                    </a>
                    <a 
                        href="/api/export/cases?format=pdf"
                        class="block w-full text-left px-4 py-2 vmp-body-small hover:vmp-bg-veil transition-colors">
                        Export to PDF
                    </a>
                    <a 
                        href="/api/export/cases?format=csv"
                        class="block w-full text-left px-4 py-2 vmp-body-small hover:vmp-bg-veil transition-colors">
                        Export to CSV
                    </a>
                    <div class="border-t vmp-border-color my-1"></div>
                    <button 
                        @click="openCustomExportModal('cases'); open = false"
                        class="w-full text-left px-4 py-2 vmp-body-small hover:vmp-bg-veil transition-colors">
                        Custom Export...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="divide-y vmp-border-color">
        {% for c in cases %}
        <a href="#" 
           class="group block px-4 py-3.5 hover:bg-white/[0.02] active:bg-white/[0.04] transition-all relative overflow-hidden"
           hx-get="/partials/case-detail.html?case_id={{ c.id }}" 
           hx-target="#case-detail-panel" 
           hx-swap="innerHTML"
           hx-indicator="#detail-loading">
            
            <div class="absolute left-0 top-0 bottom-0 w-[2px] bg-white opacity-0 transition-opacity"></div>

            <div class="flex items-start justify-between gap-3">
                
                <div class="flex items-start gap-3 min-w-0">
                    <!-- Bulk Selection Checkbox (Sprint 11.1) -->
                    <div class="mt-1.5 shrink-0">
                        <input 
                            type="checkbox" 
                            class="vmp-checkbox"
                            data-bulk-item-id="{{ c.id }}"
                            @change="document.dispatchEvent(new CustomEvent('bulk-toggle', { detail: { id: '{{ c.id }}' } }))"
                            @click.stop>
                    </div>
                    
                    <div class="mt-1.5 relative shrink-0">
                        {% set st = (c.status or '') | lower %}
                        {% if st == 'waiting_supplier' %}
                            <div class="w-1.5 h-1.5 rounded-full vmp-fill-danger animate-pulse"></div>
                            <div class="absolute inset-0 vmp-fill-danger blur-[4px] opacity-40"></div>
                        {% elif st == 'open' %}
                             <div class="w-1.5 h-1.5 rounded-full vmp-fill-warn"></div>
                        {% elif st == 'resolved' %}
                             <div class="w-1.5 h-1.5 rounded-full vmp-fill-ok opacity-50"></div>
                        {% else %}
                             <div class="w-1.5 h-1.5 rounded-full vmp-bg-panel"></div>
                        {% endif %}
                    </div>

                    <div class="min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="vmp-code">#{{ c.id|string|truncate(8, True, '') }}</span>
                            <span class="vmp-caption vmp-muted truncate max-w-[140px]">{{ c.vmp_companies.name if c.vmp_companies else 'Unknown Entity' }}</span>
                        </div>
                        
                        <div class="vmp-body-small leading-snug truncate group-hover:text-white transition-colors">
                            {{ c.subject }}
                        </div>
                        
                        <div class="mt-2 flex items-center gap-2">
                             <span class="vmp-caption vmp-muted px-1.5 py-0.5 rounded vmp-bg-panel">{{ (c.case_type or 'General') }}</span>
                             <span class="vmp-code">
                                {% if c.updated_at %}
                                    {{ c.updated_at | date('%b %d') }}
                                {% else %}
                                    2h ago
                                {% endif %}
                             </span>
                        </div>
                    </div>
                </div>

                {% if st == 'waiting_supplier' %}
                    <div class="shrink-0 px-1.5 py-0.5 rounded border vmp-status-badge-danger">
                        <span class="vmp-label vmp-signal-danger">ACT</span>
                    </div>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
</div>
