<div class="flex flex-col h-full relative" x-data>
    
    {% if error %}
    <div class="px-6 pt-4 shrink-0">
        <div class="p-3 rounded border border-rose-500/30 bg-rose-500/10 text-rose-400 font-mono text-xs">
            ERROR: {{ error }}
        </div>
    </div>
    {% endif %}

    <div class="flex-1 overflow-y-auto p-6 space-y-6 flex flex-col-reverse" id="thread-scroll-area">
        
        {% if messages and messages|length > 0 %}
            {% for msg in messages %}
            
            <div class="group flex flex-col {{ 'items-end' if msg.sender_party == 'internal' else 'items-start' }}">
                
                <div class="flex items-center gap-3 mb-2 px-1 opacity-40 group-hover:opacity-100 transition-opacity">
                    <span class="font-mono text-[10px] uppercase tracking-widest {{ 'text-emerald-400' if msg.sender_party == 'AI Assistant' else 'text-white' }}">
                        {{ msg.sender_party or 'SYSTEM' }}
                    </span>
                    <span class="text-[10px] font-mono text-white/50">
                        {{ msg.created_at | date('%H:%M') if msg.created_at else 'NOW' }}
                    </span>
                </div>

                <div class="max-w-[85%] p-4 rounded-xl border backdrop-blur-md 
                            {{ 'rounded-tr-none border-emerald-500/20 bg-emerald-500/5 text-emerald-100' if msg.sender_party == 'internal' 
                            else 'rounded-tl-none border-emerald-500/30 bg-emerald-500/10 text-emerald-100' if msg.sender_party == 'AI Assistant'
                            else 'rounded-tl-none border-white/10 bg-white/5 text-white/80' }}">
                    <div class="font-sans text-sm leading-relaxed whitespace-pre-wrap">
                        {{ msg.body or 'â€”' }}
                    </div>
                </div>

            </div>
            {% endfor %}
            
        {% else %}
            <div class="flex h-full items-center justify-center opacity-30">
                <div class="text-center">
                    <div class="font-serif text-3xl italic mb-2">Null Stream</div>
                    <div class="font-mono text-xs uppercase tracking-widest">No communications logged</div>
                </div>
            </div>
        {% endif %}

    </div>

    <div class="shrink-0 p-4 border-t border-white/10 bg-[#050505]/80 backdrop-blur-xl">
        <form class="relative" 
              hx-post="/cases/{{ caseId }}/messages" 
              hx-target="#case-thread-container"
              hx-swap="innerHTML" 
              hx-on::after-request="if(event.detail.successful) { this.reset(); }">
            
            <input type="text" 
                   name="body" 
                   placeholder="Inject message to stream..." 
                   class="w-full bg-[#0A0A0A] border border-white/10 rounded-lg py-4 pl-4 pr-12 text-sm text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/50 focus:ring-1 focus:ring-emerald-500/50 transition-all font-mono"
                   required
                   autocomplete="off">

            <button type="submit"
                    class="absolute right-2 top-2 bottom-2 aspect-square flex items-center justify-center rounded bg-white/5 hover:bg-emerald-500/20 text-white/40 hover:text-emerald-400 transition-all">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 5l7 7-7 7M5 12h14" />
                </svg>
            </button>
        </form>
    </div>
</div>