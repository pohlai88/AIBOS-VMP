{% if files and files.length > 0 %}
  <!-- Evidence Gallery Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
    {% for file in files %}
      <div class="border border-white/8 rounded-lg overflow-hidden hover:border-white/20 transition-colors group" data-file-id="{{ file.id }}">
        <!-- File Preview / Icon -->
        <div class="aspect-square bg-white/5 flex items-center justify-center relative overflow-hidden">
          {% if file.mimetype and file.mimetype.startswith('image/') %}
            <!-- Image Thumbnail -->
            <img src="{{ file.url }}"
                 alt="{{ file.filename }}"
                 class="w-full h-full object-cover group-hover:scale-105 transition-transform"
                 loading="lazy">
          {% elif file.mimetype and file.mimetype.startswith('application/pdf') %}
            <!-- PDF Icon -->
            <svg class="w-12 h-12 text-red-400" fill="currentColor" viewBox="0 0 24 24">
              <path d="M7 2h10v2H7V2zm6 12H7v2h6v-2zm-6-4h10v2H7v-2zm12-4h2v12h-2v-2h-2v2h-2V4h4v2z"/>
            </svg>
          {% elif file.mimetype and file.mimetype.startswith('application/') %}
            <!-- Document Icon -->
            <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          {% else %}
            <!-- Generic File Icon -->
            <svg class="w-12 h-12 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          {% endif %}
        </div>

        <!-- File Info -->
        <div class="p-3">
          <h4 class="font-semibold text-white text-sm truncate mb-1">
            {{ file.filename }}
          </h4>

          <div class="text-xs text-white/60 space-y-1">
            <p>
              {% if file.size %}
                {{ (file.size / 1024 / 1024) | round(2) }}MB
              {% endif %}
            </p>
            <p>
              {% if file.created_at %}
                {{ file.created_at | formatDate }}
              {% endif %}
            </p>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 mt-2">
            <a href="{{ file.url }}"
               target="_blank"
               rel="noopener noreferrer"
               class="flex-1 px-2 py-1 bg-white/10 hover:bg-white/20 text-white text-xs rounded transition-colors text-center">
              Download
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <!-- Empty State -->
  <div class="border border-white/8 rounded-lg bg-white/3 p-12 text-center">
    <svg class="w-16 h-16 text-white/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
    </svg>
    <h3 class="text-white font-semibold mb-2">No evidence files yet</h3>
    <p class="text-white/60 text-sm mb-6">Upload supporting documents, images, or files for this case.</p>

    <!-- Upload Form -->
    <form id="upload-form" class="max-w-md mx-auto">
      <div class="border-2 border-dashed border-white/20 rounded-lg p-6 hover:border-green-500/50 transition-colors cursor-pointer"
           onclick="document.getElementById('file-input').click()">
        <input type="file"
               id="file-input"
               name="file"
               style="display: none;"
               accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
               onchange="handleFileSelect(event)">

        <svg class="w-8 h-8 text-white/40 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        <p class="text-white/60 text-sm">Click to upload or drag and drop</p>
        <p class="text-white/40 text-xs mt-1">PDF, images, or documents (max 50MB)</p>
      </div>

      <button type="submit"
              id="upload-button"
              style="display: none;"
              class="mt-4 px-4 py-2 bg-green-500 hover:bg-green-600 text-black font-semibold rounded-lg text-sm transition-colors">
        Upload File
      </button>

      <!-- Progress Bar -->
      <div id="progress-container" style="display: none;" class="mt-4">
        <div class="w-full bg-white/10 rounded-full h-2">
          <div id="progress-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="text-white/60 text-xs mt-2 text-center">Uploading...</p>
      </div>
    </form>
  </div>

  <script>
    let selectedFile = null;

    function handleFileSelect(event) {
      selectedFile = event.target.files[0];
      if (selectedFile) {
        document.getElementById('upload-button').style.display = 'block';
      }
    }

    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedFile) return;

      const formData = new FormData();
      formData.append('file', selectedFile);

      const uploadButton = document.getElementById('upload-button');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      uploadButton.disabled = true;
      progressContainer.style.display = 'block';

      try {
        const xhr = new XMLHttpRequest();

        // Progress tracking
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `Uploading ${Math.round(percent)}%...`;
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status === 201) {
            // Refresh evidence gallery
            location.reload();
          } else {
            alert('Upload failed');
            progressContainer.style.display = 'none';
            uploadButton.disabled = false;
          }
        });

        xhr.addEventListener('error', () => {
          alert('Upload error');
          progressContainer.style.display = 'none';
          uploadButton.disabled = false;
        });

        xhr.open('POST', `/api/cases/{{ caseId }}/evidence`);
        xhr.send(formData);
      } catch (error) {
        console.error('Upload error:', error);
        alert('Could not upload file');
        progressContainer.style.display = 'none';
        uploadButton.disabled = false;
      }
    });
  </script>
{% endif %}
