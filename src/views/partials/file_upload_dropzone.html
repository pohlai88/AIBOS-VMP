<!-- Supabase-style File Upload Dropzone Component
     Usage: Include this partial in your forms
     Requires: Alpine.js for drag/drop handling
-->

<div class="vmp-dropzone" x-data="{
       files: [],
       isDragging: false,
       maxSize: {% if maxSize %}{{ maxSize }}{% else %}10485760{% endif %},
       acceptedTypes: {% if acceptedTypes %}{{ acceptedTypes | tojson }}{% else %}[]{% endif %},
       handleFiles(filesList) {
         Array.from(filesList).forEach(file => {
           if (file.size > this.maxSize) {
             alert('File too large. Maximum size: ' + (this.maxSize / 1048576).toFixed(1) + 'MB');
             return;
           }
           const fileItem = {
             file: file,
             name: file.name,
             size: file.size,
             type: file.type,
             status: 'pending',
             progress: 0,
             preview: null
           };
           // Generate preview for images
           if (file.type.startsWith('image/')) {
             const reader = new FileReader();
             reader.onload = (e) => {
               fileItem.preview = e.target.result;
             };
             reader.readAsDataURL(file);
           }
           this.files.push(fileItem);
         });
         // Add visual feedback class
         this.$el.classList.add('has-files');
       }
     }" @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false"
  @drop.prevent="isDragging = false; handleFiles($event.dataTransfer.files)" 
  :class="{ 'dragover': isDragging, 'has-files': files.length > 0 }">

  <input type="file" {% if multiple %}multiple{% endif %} {% if acceptedTypes %}accept="{{ acceptedTypes }}" {% else
    %}accept="*/*" {% endif %} @change="handleFiles($event.target.files)" x-ref="fileInput" />

  <div class="vmp-dropzone-icon">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
  </div>

  <div class="vmp-dropzone-text">
    <span x-show="files.length === 0">Drag and drop files here, or click to select</span>
    <span x-show="files.length > 0" x-text="files.length + ' file(s) selected'"></span>
  </div>

  <div class="vmp-dropzone-hint">
    Maximum file size: <span x-text="(maxSize / 1048576).toFixed(1)"></span>MB
  </div>
</div>

<!-- File List -->
<div class="vmp-file-list" x-show="files.length > 0" x-cloak>
  <template x-for="(fileItem, index) in files" :key="index">
    <div class="vmp-file-item">
      <!-- Image Preview (Mobile) -->
      <div class="vmp-file-item-preview" x-show="fileItem.preview && fileItem.type.startsWith('image/')">
        <img :src="fileItem.preview" :alt="fileItem.name" />
      </div>
      <div class="vmp-file-item-info">
        <div class="vmp-file-item-icon">
          <svg x-show="!fileItem.preview || !fileItem.type.startsWith('image/')" 
               xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <svg x-show="fileItem.preview && fileItem.type.startsWith('image/')" 
               xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="vmp-file-item-details">
          <div class="vmp-file-item-name" x-text="fileItem.name"></div>
          <div class="vmp-file-item-size" x-text="(fileItem.size / 1024).toFixed(1) + ' KB'"></div>
        </div>
      </div>
      <div class="vmp-file-item-status">
        <span class="vmp-badge" x-show="fileItem.status === 'pending'" x-text="'Pending'"></span>
        <span class="vmp-badge vmp-badge-ok" x-show="fileItem.status === 'uploaded'" x-text="'Uploaded'"></span>
        <span class="vmp-badge vmp-badge-danger" x-show="fileItem.status === 'error'" x-text="'Error'"></span>
        <button type="button" 
                class="vmp-file-item-remove" 
                @click="files.splice(index, 1); if (files.length === 0) $el.closest('.vmp-dropzone').classList.remove('has-files');" 
                aria-label="Remove file"
                style="min-width: 44px; min-height: 44px;">
          Ã—
        </button>
      </div>
      <!-- Upload Progress -->
      <div class="vmp-upload-progress" x-show="fileItem.status === 'uploading'">
        <div class="vmp-upload-progress-bar" :style="'--progress-width: ' + fileItem.progress + '%'"></div>
      </div>
    </div>
  </template>
</div>