<div class="vmp-panel p-6 border shadow-lg" style="border-color: var(--vmp-border);">
    
    <div id="invite-feedback"></div>

    <div class="mb-6 border-b pb-4" style="border-color: var(--vmp-border);">
        <h3 class="vmp-h4 mb-1">Invite Supplier</h3>
        <p class="vmp-caption opacity-60">Generate a secure onboarding token for a new vendor.</p>
    </div>

    <form hx-post="/ops/invites"
          hx-target="#invite-result"
          hx-swap="innerHTML"
          hx-indicator="#invite-loading"
          class="space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
                <label class="vmp-label mb-2 block opacity-70">Company Name</label>
                <input type="text" 
                       name="vendor_name" 
                       required 
                       class="vmp-input w-full"
                       placeholder="e.g. Acme Logistics Ltd.">
            </div>
            <div>
                <label class="vmp-label mb-2 block opacity-70">Contact Email</label>
                <input type="email" 
                       name="email" 
                       required 
                       class="vmp-input w-full"
                       placeholder="vendor@acme.com">
            </div>
        </div>

        {% if orgTree %}
        <div>
            <div class="flex justify-between items-end mb-3">
                <label class="vmp-label opacity-70">Authorization Scope</label>
                <span class="vmp-code-small opacity-40 text-[10px]">SELECT ENTITIES</span>
            </div>
            
            <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                
                {% if orgTree.groups and orgTree.groups|length > 0 %}
                <div class="space-y-3">
                    {% for group in orgTree.groups %}
                    <div class="p-3 rounded-lg border transition-colors hover:bg-[var(--vmp-bg)]" 
                         style="border-color: var(--vmp-border); background: var(--vmp-panel);">
                        
                        <label class="flex items-center gap-3 cursor-pointer mb-2">
                            <input type="checkbox" 
                                   class="vmp-checkbox group-checkbox"
                                   data-group-id="{{ group.id }}"
                                   onchange="toggleGroupCompanies(this, '{{ group.id }}')">
                            <div>
                                <div class="vmp-body-small font-medium">{{ group.name }}</div>
                                <div class="vmp-caption opacity-50">{{ group.companies|length }} linked entities</div>
                            </div>
                        </label>

                        {% if group.companies and group.companies|length > 0 %}
                        <div class="ml-7 pl-3 border-l space-y-2 pt-1" style="border-color: var(--vmp-border);">
                            {% for company in group.companies %}
                            <label class="flex items-center gap-3 cursor-pointer opacity-80 hover:opacity-100 transition-opacity">
                                <input type="checkbox" 
                                       name="company_ids" 
                                       value="{{ company.id }}"
                                       class="vmp-checkbox company-checkbox"
                                       data-group-id="{{ group.id }}">
                                <span class="vmp-body-small">{{ company.name }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if orgTree.ungroupedCompanies and orgTree.ungroupedCompanies|length > 0 %}
                <div class="pt-2">
                    <div class="vmp-caption opacity-40 mb-2 uppercase tracking-widest text-[10px]">Ungrouped</div>
                    <div class="space-y-2">
                        {% for company in orgTree.ungroupedCompanies %}
                        <label class="flex items-center gap-3 p-2 rounded border cursor-pointer hover:bg-[var(--vmp-panel)] transition-colors"
                               style="border-color: var(--vmp-border);">
                            <input type="checkbox" 
                                   name="company_ids" 
                                   value="{{ company.id }}"
                                   class="vmp-checkbox company-checkbox">
                            <span class="vmp-body-small">{{ company.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="pt-4 border-t flex justify-end items-center gap-4" style="border-color: var(--vmp-border);">
            <div id="invite-loading" class="htmx-indicator flex items-center gap-2">
                <div class="vmp-spinner w-4 h-4"></div>
                <span class="vmp-caption opacity-60">Generating keys...</span>
            </div>
            <button type="submit" class="vmp-btn vmp-btn-primary">
                <span class="vmp-label text-[var(--vmp-bg)]">Generate Invite</span>
            </button>
        </div>
    </form>

    <div id="invite-result" class="mt-6 empty:hidden animate-in fade-in slide-in-from-top-4 duration-300"></div>
</div>

<script>
function toggleGroupCompanies(groupCheckbox, groupId) {
  const checkboxes = document.querySelectorAll(`.company-checkbox[data-group-id="${groupId}"]`);
  checkboxes.forEach(cb => (cb.checked = groupCheckbox.checked));
}

// Auto-check parent group if all children are checked
document.addEventListener('change', e => {
  if (e.target.classList.contains('company-checkbox')) {
    const groupId = e.target.dataset.groupId;
    if (groupId) {
      const groupCb = document.querySelector(`.group-checkbox[data-group-id="${groupId}"]`);
      const siblings = Array.from(
        document.querySelectorAll(`.company-checkbox[data-group-id="${groupId}"]`)
      );
      if (groupCb) {
        groupCb.checked = siblings.every(cb => cb.checked);
        groupCb.indeterminate = siblings.some(cb => cb.checked) && !groupCb.checked;
      }
    }
  }
});
</script>