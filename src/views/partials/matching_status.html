<!-- Matching Status Partial (Enhanced for Sprint 7.1) -->
<div class="p-5 border-b vmp-border-color">
    <div class="vmp-label-kicker vmp-label-kicker-strong mb-4">3-WAY MATCHING STATUS</div>

    {% if error %}
    <div class="p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-30">
        <div class="vmp-caption vmp-text-warn">{{ error }}</div>
    </div>
    {% elif matchingStatus %}
    <!-- Match State Badge -->
    <div class="mb-4">
        <div class="vmp-panel px-4 py-3 rounded-lg border vmp-border-color flex items-center justify-between
            {% if matchingStatus.match_state == 'READY' %} vmp-bg-ok vmp-opacity-20 vmp-border-ok
            {% elif matchingStatus.match_state == 'WARN' %} vmp-bg-warn vmp-opacity-20 vmp-border-warn
            {% elif matchingStatus.match_state == 'BLOCK' %} vmp-bg-danger vmp-opacity-20 vmp-border-danger
            {% endif %}">
            <div>
                <div class="vmp-label-kicker opacity-50 mb-0.5">MATCH STATE</div>
                <div class="vmp-label 
                    {% if matchingStatus.match_state == 'READY' %} vmp-text-ok
                    {% elif matchingStatus.match_state == 'WARN' %} vmp-text-warn
                    {% elif matchingStatus.match_state == 'BLOCK' %} vmp-text-danger
                    {% endif %}">
                    {{ matchingStatus.match_state }}
                </div>
            </div>
            <div class="w-2 h-12 rounded-full overflow-hidden relative vmp-bg-panel">
                <div class="absolute bottom-0 left-0 right-0 
                    {% if matchingStatus.match_state == 'READY' %} vmp-fill-ok h-full
                    {% elif matchingStatus.match_state == 'WARN' %} vmp-fill-warn h-2/3
                    {% elif matchingStatus.match_state == 'BLOCK' %} vmp-fill-danger h-full animate-pulse
                    {% endif %}">
                </div>
            </div>
        </div>
    </div>

    <!-- Visual 3-Way Match Diagram -->
    <div class="mb-4">
        <div class="vmp-label-kicker mb-3">3-WAY MATCH DIAGRAM</div>
        <div class="vmp-panel p-4 rounded-lg border vmp-border-color">
            <div class="grid grid-cols-3 gap-4">
                <!-- PO Card -->
                <div class="flex flex-col items-center">
                    <div class="w-full vmp-panel p-3 rounded-lg border vmp-border-color text-center
                        {% if matchingStatus.po_match and matchingStatus.po_match.status == 'open' %} vmp-bg-ok vmp-opacity-20 vmp-border-ok
                        {% elif matchingStatus.invoice_po_ref and not matchingStatus.po_match %} vmp-bg-danger vmp-opacity-20 vmp-border-danger
                        {% elif matchingStatus.po_match %} vmp-bg-warn vmp-opacity-20 vmp-border-warn
                        {% else %} vmp-opacity-30
                        {% endif %}">
                        <div class="vmp-label-kicker opacity-50 mb-1">PO</div>
                        {% if matchingStatus.po_match %}
                            <div class="vmp-body-small font-mono mb-1">{{ matchingStatus.po_match.po_number }}</div>
                            <div class="vmp-caption 
                                {% if matchingStatus.po_match.status == 'open' %} vmp-text-ok
                                {% else %} vmp-text-warn
                                {% endif %}">
                                {% if matchingStatus.po_match.status == 'open' %}✅{% else %}⚠️{% endif %}
                            </div>
                            {% if matchingStatus.po_match.total_amount %}
                            <div class="vmp-caption vmp-muted mt-1">
                                {{ matchingStatus.invoice_currency }} {{ "%.2f"|format(matchingStatus.po_match.total_amount) }}
                            </div>
                            {% endif %}
                        {% elif matchingStatus.invoice_po_ref %}
                            <div class="vmp-caption vmp-text-danger">Not Found</div>
                            <div class="vmp-caption vmp-muted text-xs mt-1">{{ matchingStatus.invoice_po_ref }}</div>
                        {% else %}
                            <div class="vmp-caption vmp-muted">No Reference</div>
                        {% endif %}
                    </div>
                </div>

                <!-- GRN Card -->
                <div class="flex flex-col items-center">
                    <div class="w-full vmp-panel p-3 rounded-lg border vmp-border-color text-center
                        {% if matchingStatus.grn_match and matchingStatus.grn_match.status == 'verified' %} vmp-bg-ok vmp-opacity-20 vmp-border-ok
                        {% elif matchingStatus.invoice_grn_ref and not matchingStatus.grn_match %} vmp-bg-danger vmp-opacity-20 vmp-border-danger
                        {% elif matchingStatus.grn_match %} vmp-bg-warn vmp-opacity-20 vmp-border-warn
                        {% else %} vmp-opacity-30
                        {% endif %}">
                        <div class="vmp-label-kicker opacity-50 mb-1">GRN</div>
                        {% if matchingStatus.grn_match %}
                            <div class="vmp-body-small font-mono mb-1">{{ matchingStatus.grn_match.grn_number }}</div>
                            <div class="vmp-caption 
                                {% if matchingStatus.grn_match.status == 'verified' %} vmp-text-ok
                                {% else %} vmp-text-warn
                                {% endif %}">
                                {% if matchingStatus.grn_match.status == 'verified' %}✅{% else %}⚠️{% endif %}
                            </div>
                            {% if matchingStatus.grn_match.total_amount %}
                            <div class="vmp-caption vmp-muted mt-1">
                                {{ matchingStatus.invoice_currency }} {{ "%.2f"|format(matchingStatus.grn_match.total_amount) }}
                            </div>
                            {% endif %}
                        {% elif matchingStatus.invoice_grn_ref %}
                            <div class="vmp-caption vmp-text-danger">Not Found</div>
                            <div class="vmp-caption vmp-muted text-xs mt-1">{{ matchingStatus.invoice_grn_ref }}</div>
                        {% else %}
                            <div class="vmp-caption vmp-muted">No Reference</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Invoice Card -->
                <div class="flex flex-col items-center">
                    <div class="w-full vmp-panel p-3 rounded-lg border vmp-border-color text-center
                        {% if matchingStatus.match_state == 'READY' %} vmp-bg-ok vmp-opacity-20 vmp-border-ok
                        {% elif matchingStatus.match_state == 'BLOCK' %} vmp-bg-danger vmp-opacity-20 vmp-border-danger
                        {% else %} vmp-bg-warn vmp-opacity-20 vmp-border-warn
                        {% endif %}">
                        <div class="vmp-label-kicker opacity-50 mb-1">INVOICE</div>
                        <div class="vmp-body-small font-mono mb-1">INV</div>
                        <div class="vmp-caption 
                            {% if matchingStatus.match_state == 'READY' %} vmp-text-ok
                            {% elif matchingStatus.match_state == 'BLOCK' %} vmp-text-danger
                            {% else %} vmp-text-warn
                            {% endif %}">
                            {% if matchingStatus.match_state == 'READY' %}✅{% elif matchingStatus.match_state == 'BLOCK' %}❌{% else %}⚠️{% endif %}
                        </div>
                        {% if matchingStatus.invoice_amount %}
                        <div class="vmp-caption vmp-muted mt-1">
                            {{ matchingStatus.invoice_currency }} {{ "%.2f"|format(matchingStatus.invoice_amount) }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Connection Lines (Visual) -->
            <div class="mt-3 flex justify-center items-center gap-2">
                <div class="flex-1 h-px 
                    {% if matchingStatus.po_match and matchingStatus.po_match.status == 'open' %} vmp-bg-ok
                    {% elif matchingStatus.invoice_po_ref %} vmp-bg-danger
                    {% else %} vmp-border-color
                    {% endif %}"></div>
                <div class="w-2 h-2 rounded-full 
                    {% if matchingStatus.grn_match and matchingStatus.grn_match.status == 'verified' %} vmp-bg-ok
                    {% elif matchingStatus.invoice_grn_ref %} vmp-bg-danger
                    {% else %} vmp-border-color
                    {% endif %}"></div>
                <div class="flex-1 h-px 
                    {% if matchingStatus.grn_match and matchingStatus.grn_match.status == 'verified' %} vmp-bg-ok
                    {% elif matchingStatus.invoice_grn_ref %} vmp-bg-danger
                    {% else %} vmp-border-color
                    {% endif %}"></div>
            </div>
        </div>
    </div>

    <!-- Mismatch Highlighting -->
    {% if matchingStatus.mismatches and (matchingStatus.mismatches.amount|length > 0 or matchingStatus.mismatches.date|length > 0) %}
    <div class="mb-4">
        <div class="vmp-label-kicker mb-2 vmp-text-warn">⚠️ MISMATCHES DETECTED</div>
        <div class="space-y-2">
            {% for mismatch in matchingStatus.mismatches.amount %}
            <div class="vmp-panel p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-20">
                <div class="vmp-caption vmp-text-warn font-semibold mb-1">Amount Mismatch</div>
                {% if mismatch.type == 'po_invoice' %}
                    <div class="vmp-caption vmp-text-warn">
                        PO: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.po_amount) }} vs 
                        Invoice: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.invoice_amount) }}
                        <span class="vmp-label-kicker">(Diff: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.difference) }})</span>
                    </div>
                {% elif mismatch.type == 'grn_invoice' %}
                    <div class="vmp-caption vmp-text-warn">
                        GRN: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.grn_amount) }} vs 
                        Invoice: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.invoice_amount) }}
                        <span class="vmp-label-kicker">(Diff: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.difference) }})</span>
                    </div>
                {% elif mismatch.type == 'po_grn' %}
                    <div class="vmp-caption vmp-text-warn">
                        PO: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.po_amount) }} vs 
                        GRN: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.grn_amount) }}
                        <span class="vmp-label-kicker">(Diff: {{ mismatch.currency }} {{ "%.2f"|format(mismatch.difference) }})</span>
                    </div>
                {% endif %}
            </div>
            {% endfor %}
            {% for mismatch in matchingStatus.mismatches.date %}
            <div class="vmp-panel p-3 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-20">
                <div class="vmp-caption vmp-text-warn font-semibold mb-1">Date Mismatch</div>
                <div class="vmp-caption vmp-text-warn">
                    {% if mismatch.type == 'po_invoice' %}
                        PO Date vs Invoice Date: {{ mismatch.days_difference }} days difference
                    {% elif mismatch.type == 'grn_invoice' %}
                        GRN Date vs Invoice Date: {{ mismatch.days_difference }} days difference
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Exceptions List -->
    {% if matchingStatus.exceptions and matchingStatus.exceptions|length > 0 %}
    <div class="mb-4">
        <div class="vmp-label-kicker mb-2">EXCEPTIONS</div>
        <div class="space-y-2">
            {% for exception in matchingStatus.exceptions %}
            <div class="vmp-caption vmp-text-warn flex items-center gap-2">
                <span>⚠️</span>
                <span>{{ exception }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="mt-4 space-y-2">
        <!-- Report Exception Button (Opens Modal) -->
        <button type="button" 
                onclick="document.getElementById('exception-modal-{{ matchingStatus.invoice_id }}').style.display='flex'"
                class="vmp-btn vmp-btn-primary w-full">
            Report Exception
        </button>

        {% if not matchingStatus.grn_match and matchingStatus.invoice_grn_ref %}
        <form hx-post="/invoices/{{ matchingStatus.invoice_id }}/request-grn" 
              hx-target="#matching-status-container" 
              hx-swap="innerHTML"
              hx-indicator="#grn-request-loading">
            <button type="submit" class="vmp-btn vmp-btn-primary w-full">
                Request GRN
            </button>
            <div id="grn-request-loading" class="htmx-indicator vmp-spinner"></div>
        </form>
        {% endif %}
        
        {% if matchingStatus.mismatches and matchingStatus.mismatches.amount|length > 0 %}
        <form hx-post="/invoices/{{ matchingStatus.invoice_id }}/dispute-amount" 
              hx-target="#matching-status-container" 
              hx-swap="innerHTML"
              hx-indicator="#dispute-loading">
            <button type="submit" class="vmp-btn vmp-btn-danger w-full">
                Dispute Amount
            </button>
            <div id="dispute-loading" class="htmx-indicator vmp-spinner"></div>
        </form>
        {% endif %}
    </div>

    <!-- Exception Selection Modal -->
    <div id="exception-modal-{{ matchingStatus.invoice_id }}" 
         class="vmp-modal-overlay" 
         style="display: none;"
         onclick="if(event.target === this) this.style.display='none'">
        <div class="vmp-modal vmp-modal-md">
            <div class="vmp-modal-header">
                <h3 class="vmp-h3">Report Exception</h3>
                <p class="vmp-caption vmp-muted mt-1">Select the type of exception to create a case</p>
            </div>
            <div class="vmp-modal-body">
                <form hx-post="/invoices/{{ matchingStatus.invoice_id }}/report-exception"
                      hx-target="#matching-status-container"
                      hx-swap="innerHTML"
                      hx-indicator="#exception-submit-loading"
                      onsubmit="document.getElementById('exception-modal-{{ matchingStatus.invoice_id }}').style.display='none'">
                    <div class="space-y-3">
                        <div>
                            <label class="vmp-label-kicker mb-2 block">Exception Type</label>
                            <select name="exception_type" class="vmp-select w-full" required>
                                <option value="">Select exception type...</option>
                                {% if not matchingStatus.grn_match and matchingStatus.invoice_grn_ref %}
                                <option value="missing_grn">Missing GRN (GRN {{ matchingStatus.invoice_grn_ref }} not found)</option>
                                {% endif %}
                                {% if not matchingStatus.po_match and matchingStatus.invoice_po_ref %}
                                <option value="missing_po">Missing PO (PO {{ matchingStatus.invoice_po_ref }} not found)</option>
                                {% endif %}
                                {% if matchingStatus.mismatches and matchingStatus.mismatches.amount|length > 0 %}
                                <option value="amount_mismatch">Amount Mismatch</option>
                                {% endif %}
                                {% if matchingStatus.mismatches and matchingStatus.mismatches.date|length > 0 %}
                                <option value="date_mismatch">Date Mismatch</option>
                                {% endif %}
                                {% if matchingStatus.po_match and matchingStatus.po_match.status != 'open' %}
                                <option value="po_status">PO Status Issue (PO is {{ matchingStatus.po_match.status }})</option>
                                {% endif %}
                                {% if matchingStatus.grn_match and matchingStatus.grn_match.status != 'verified' %}
                                <option value="grn_status">GRN Status Issue (GRN is {{ matchingStatus.grn_match.status }})</option>
                                {% endif %}
                            </select>
                        </div>
                        <div>
                            <label class="vmp-label-kicker mb-2 block">Additional Notes (Optional)</label>
                            <textarea name="notes" 
                                      class="vmp-textarea w-full" 
                                      rows="3" 
                                      placeholder="Add any additional context about this exception..."></textarea>
                        </div>
                    </div>
                    <div class="vmp-modal-footer flex gap-3 mt-4">
                        <button type="button" 
                                onclick="document.getElementById('exception-modal-{{ matchingStatus.invoice_id }}').style.display='none'"
                                class="vmp-btn vmp-btn-ghost flex-1">
                            Cancel
                        </button>
                        <button type="submit" class="vmp-btn vmp-btn-primary flex-1">
                            Create Case
                            <div id="exception-submit-loading" class="htmx-indicator vmp-spinner ml-2"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="vmp-caption vmp-muted">No matching status available</div>
    {% endif %}
</div>

