<div class="flex flex-col h-full bg-[#050505] border-r border-white/5">

    <div class="p-6 pb-2 shrink-0">
        <div class="mb-8 opacity-90">
            <div class="flex items-center gap-3 mb-2">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-white/10 to-transparent border border-white/10 flex items-center justify-center shadow-[0_0_15px_rgba(255,255,255,0.05)]">
                    <div class="w-3 h-3 bg-white rounded-full shadow-[0_0_10px_white]"></div>
                </div>
                <div class="font-serif text-xl text-white tracking-tight">NexusCanon</div>
            </div>

            <div class="text-[10px] font-mono text-white/30 tracking-widest uppercase pl-1">
                Settlement OS <span class="text-[#00ff9d]">v3.1</span>
            </div>
        </div>
    </div>

    <nav class="flex-1 overflow-y-auto px-3 space-y-6 scrollbar-hide">

        {% if error %}
        <div class="mx-2 p-3 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-mono">
            ⚠ Error: {{ error }}
        </div>
        {% endif %}

        {% if not orgTree and not error %}
        <div class="mx-2 p-3 rounded bg-amber-500/10 border border-amber-500/20 text-amber-400 text-xs font-mono">
            ⚠ No organization data available. Please check server logs.
        </div>
        {% endif %}

        {% if orgTree %}

        <div class="space-y-1">
            <div class="px-3 text-[9px] font-mono font-bold tracking-[0.2em] text-white/20 uppercase mb-2">
                Global Scope
            </div>

            <a href="/ops/dashboard" hx-get="/ops/dashboard" hx-target="#main-content" hx-push-url="true"
                class="group flex items-center gap-3 px-3 py-2 rounded-md text-[13px] transition-all relative overflow-hidden border border-transparent
                      {{ 'bg-white/[0.06] border-white/5 text-white shadow-[0_0_15px_rgba(0,0,0,0.5)]' if not currentScope.type else 'text-white/50 hover:text-white hover:bg-white/[0.02]' }}">

                {% if not currentScope.type %}
                <div class="absolute left-0 top-1 bottom-1 w-[3px] bg-[#00ff9d] rounded-r-sm shadow-[0_0_8px_#00ff9d]">
                </div>
                {% endif %}

                <svg class="w-4 h-4 {{ 'text-[#00ff9d]' if not currentScope.type else 'opacity-50 group-hover:opacity-100' }}"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path
                        d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                    </path>
                </svg>

                <span class="tracking-wide font-medium">{{ orgTree.tenant.name or 'Holding Corp' }}</span>
            </a>
        </div>

        {% if orgTree.groups and orgTree.groups|length > 0 %}
        <div class="space-y-1">
            <div class="px-3 text-[9px] font-mono font-bold tracking-[0.2em] text-white/20 uppercase mb-2 mt-6">
                Operational Units
            </div>

            {% for group in orgTree.groups %}
            <div x-data="{ open: {{ 'true' if currentScope.type == 'group' and currentScope.id == group.id else 'true' }} }"
                class="relative">

                <div
                    class="flex items-center group relative rounded-md transition-all
                            {{ 'bg-white/[0.04] text-white' if currentScope.type == 'group' and currentScope.id == group.id else 'hover:bg-white/[0.02]' }}">

                    {% if currentScope.type == 'group' and currentScope.id == group.id %}
                    <div
                        class="absolute left-0 top-1 bottom-1 w-[3px] bg-[#00ff9d] rounded-r-sm shadow-[0_0_8px_#00ff9d]">
                    </div>
                    {% endif %}

                    <a href="/ops/dashboard?scope_id={{ group.id }}" hx-get="/ops/dashboard?scope_id={{ group.id }}"
                        hx-target="#main-content"
                        class="flex-1 flex items-center gap-3 px-3 py-2 text-[13px] {{ 'text-white' if currentScope.type == 'group' and currentScope.id == group.id else 'text-white/60 hover:text-white' }}">
                        <svg class="w-4 h-4 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5">
                            <path
                                d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
                        </svg>
                        <span class="tracking-wide">{{ group.name }}</span>
                    </a>

                    {% if group.companies|length > 0 %}
                    <button @click.prevent="open = !open"
                        class="p-2 mr-1 text-white/20 hover:text-white transition-colors">
                        <svg class="w-3 h-3 transition-transform duration-200" :class="open ? 'rotate-90' : ''"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6" />
                        </svg>
                    </button>
                    {% endif %}
                </div>

                {% if group.companies and group.companies|length > 0 %}
                <div x-show="open" x-collapse class="ml-[1.1rem] pl-3 border-l border-white/10 space-y-[2px] mt-1 mb-2">

                    {% for company in group.companies %}
                    <a href="/ops/dashboard?scope_id={{ company.id }}" hx-get="/ops/dashboard?scope_id={{ company.id }}"
                        hx-target="#main-content"
                        class="flex items-center justify-between px-3 py-2 rounded text-[12px] transition-colors relative group/item
                              {{ 'text-[#00ff9d] bg-[#00ff9d]/10' if currentScope.type == 'company' and currentScope.id == company.id else 'text-white/40 hover:text-white hover:bg-white/[0.04]' }}">

                        <div class="flex items-center gap-2 min-w-0">
                            {% if company.alert_count and company.alert_count > 0 %}
                            <span
                                class="w-1.5 h-1.5 rounded-full bg-[#ff3333] shadow-[0_0_5px_#ff3333] animate-pulse"></span>
                            {% endif %}

                            <span class="truncate">{{ company.name }}</span>
                        </div>

                        <span class="font-mono text-[9px] opacity-30 group-hover/item:opacity-70">{{ company.code or
                            'ENT' }}</span>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if orgTree.ungroupedCompanies and orgTree.ungroupedCompanies|length > 0 %}
        <div class="space-y-1 pt-4">
            <div class="px-3 text-[9px] font-mono font-bold tracking-[0.2em] text-white/20 uppercase mb-2">
                Ungrouped Entities
            </div>
            {% for company in orgTree.ungroupedCompanies %}
            <a href="/ops/dashboard?scope_id={{ company.id }}" hx-get="/ops/dashboard?scope_id={{ company.id }}"
                hx-target="#main-content"
                class="flex items-center justify-between px-3 py-2 rounded-md text-[13px] transition-colors group relative overflow-hidden
                      {{ 'bg-white/[0.04] text-white' if currentScope.type == 'company' and currentScope.id == company.id else 'text-white/60 hover:text-white hover:bg-white/[0.02]' }}">

                {% if currentScope.type == 'company' and currentScope.id == company.id %}
                <div class="absolute left-0 top-1 bottom-1 w-[3px] bg-[#00ff9d] rounded-r-sm shadow-[0_0_8px_#00ff9d]">
                </div>
                {% endif %}

                <span class="tracking-wide">{{ company.name }}</span>
                <span class="font-mono text-[10px] opacity-40">{{ company.country_code }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {% else %}
        <div class="px-4 py-12 text-center">
            <div
                class="w-12 h-12 mx-auto mb-3 rounded-full bg-white/5 border border-white/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-white/20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="1.5">
                    <path d="M12 2v20M2 12h20" />
                </svg>
            </div>
            <div class="text-white/40 font-mono text-[10px] tracking-widest uppercase mb-2">No Topology Found</div>
            <p class="text-white/20 text-xs leading-relaxed">Initialize the Organization Tree to activate scope
                controls.</p>
        </div>
        {% endif %}

    </nav>

    <div class="p-4 border-t border-white/[0.06] shrink-0 bg-[#050505]/50 backdrop-blur-sm">
        {% if user %}
        <div
            class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/[0.03] transition-colors cursor-pointer group border border-transparent hover:border-white/5">

            <div
                class="w-8 h-8 rounded bg-white/5 border border-white/10 flex items-center justify-center text-xs font-bold text-white/60 font-mono group-hover:text-[#00ff9d] group-hover:border-[#00ff9d]/30 transition-colors">
                {{ user.name[0] if user.name else 'OP' }}
            </div>

            <div class="flex-1 min-w-0">
                <div class="text-[13px] font-medium text-white/80 truncate group-hover:text-white transition-colors">{{
                    user.name or user.email }}</div>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[#00ff9d]"></span>
                    <div class="text-[9px] font-mono text-white/30 truncate uppercase tracking-wider">
                        SECURE // {{ 'ADMIN' if user.role == 'admin' else 'OPERATOR' }}
                    </div>
                </div>
            </div>

            <form action="/logout" method="POST">
                <button type="submit" class="text-white/20 hover:text-[#ff3333] transition-colors p-1.5"
                    title="Disconnect Session">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </form>
        </div>
        {% endif %}
    </div>

</div>