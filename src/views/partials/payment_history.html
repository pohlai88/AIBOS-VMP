<!-- Payment History Timeline Partial (Sprint 7.3) -->
<div class="flex flex-col h-full">
    {% if error %}
    <div class="p-3 m-4 rounded-lg border vmp-border-warn vmp-bg-warn vmp-opacity-30">
        <div class="vmp-caption vmp-text-warn">{{ error }}</div>
    </div>
    {% endif %}

    <!-- Filters and Export -->
    <div class="sticky top-0 z-10 vmp-component-card-header backdrop-blur-md flex gap-2 overflow-x-auto py-3 mb-4">
        <form hx-get="/partials/payment-history.html" 
              hx-target="#payment-history-container" 
              hx-swap="innerHTML"
              class="flex gap-2 items-center flex-1">
            <input type="text" 
                   name="payment_ref" 
                   placeholder="Payment ref..." 
                   class="vmp-input text-sm"
                   value="{{ query.payment_ref or '' }}">
            <input type="text" 
                   name="invoice_num" 
                   placeholder="Invoice #..." 
                   class="vmp-input text-sm"
                   value="{{ query.invoice_num or '' }}">
            <input type="date" 
                   name="date_from" 
                   placeholder="From" 
                   class="vmp-input text-sm"
                   value="{{ query.date_from or '' }}">
            <input type="date" 
                   name="date_to" 
                   placeholder="To" 
                   class="vmp-input text-sm"
                   value="{{ query.date_to or '' }}">
            <input type="number" 
                   name="amount_min" 
                   placeholder="Min amount" 
                   step="0.01"
                   class="vmp-input text-sm"
                   value="{{ query.amount_min or '' }}">
            <input type="number" 
                   name="amount_max" 
                   placeholder="Max amount" 
                   step="0.01"
                   class="vmp-input text-sm"
                   value="{{ query.amount_max or '' }}">
            <select name="status" class="vmp-select text-sm">
                <option value="">All Status</option>
                <option value="with_remittance" {% if query.status == 'with_remittance' %}selected{% endif %}>With Remittance</option>
                <option value="without_remittance" {% if query.status == 'without_remittance' %}selected{% endif %}>Without Remittance</option>
            </select>
            <button type="submit" class="vmp-btn vmp-btn-primary text-sm">Filter</button>
        </form>
        
        <!-- CSV Export Button -->
        <form action="/payments/history/export" method="GET" class="inline">
            {% if query.payment_ref %}<input type="hidden" name="payment_ref" value="{{ query.payment_ref }}">{% endif %}
            {% if query.invoice_num %}<input type="hidden" name="invoice_num" value="{{ query.invoice_num }}">{% endif %}
            {% if query.date_from %}<input type="hidden" name="date_from" value="{{ query.date_from }}">{% endif %}
            {% if query.date_to %}<input type="hidden" name="date_to" value="{{ query.date_to }}">{% endif %}
            {% if query.amount_min %}<input type="hidden" name="amount_min" value="{{ query.amount_min }}">{% endif %}
            {% if query.amount_max %}<input type="hidden" name="amount_max" value="{{ query.amount_max }}">{% endif %}
            {% if query.status %}<input type="hidden" name="status" value="{{ query.status }}">{% endif %}
            {% if query.company_id %}<input type="hidden" name="company_id" value="{{ query.company_id }}">{% endif %}
            <button type="submit" class="vmp-btn vmp-btn-ghost text-sm whitespace-nowrap">
                Export CSV
            </button>
        </form>
    </div>

    <!-- Payment Timeline -->
    <div class="flex-1 overflow-y-auto">
        {% if payments and payments|length > 0 %}
        <div class="relative">
            <!-- Timeline Line -->
            <div class="absolute left-8 top-0 bottom-0 w-px vmp-border-color"></div>

            <!-- Timeline Items -->
            <div class="space-y-6">
                {% for payment in payments %}
                <div class="relative flex items-start gap-4">
                    <!-- Timeline Dot -->
                    <div class="relative z-10 shrink-0">
                        <div class="w-4 h-4 rounded-full vmp-bg-panel border-2 vmp-border-color
                            {% if payment.remittance_url %}vmp-border-ok{% endif %}">
                            {% if payment.remittance_url %}
                            <div class="w-2 h-2 rounded-full vmp-bg-ok absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Payment Card -->
                    <div class="flex-1 vmp-panel p-4 rounded-lg border vmp-border-color hover:border-opacity-60 transition-all">
                        <div class="flex items-start justify-between gap-4 mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="vmp-code">#{{ payment.payment_ref }}</span>
                                    <span class="vmp-caption vmp-muted">
                                        {{ payment.vmp_companies.name if payment.vmp_companies else 'Unknown Company' }}
                                    </span>
                                    {% if payment.remittance_url %}
                                    <span class="vmp-badge vmp-badge-ok text-xs">Remittance</span>
                                    {% endif %}
                                </div>
                                
                                {% if payment.vmp_invoices %}
                                <div class="vmp-body-small vmp-muted mb-2">
                                    Invoice: {{ payment.vmp_invoices.invoice_num }}
                                </div>
                                {% elif payment.invoice_num %}
                                <div class="vmp-body-small vmp-muted mb-2">
                                    Invoice: {{ payment.invoice_num }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="text-right shrink-0">
                                <div class="vmp-h4 vmp-text-ok mb-1">
                                    {{ payment.currency_code or 'USD' }} {{ "%.2f"|format(payment.amount) if payment.amount else '0.00' }}
                                </div>
                                <div class="vmp-caption vmp-muted">
                                    {{ payment.payment_date | date('%b %d, %Y') if payment.payment_date else 'â€”' }}
                                </div>
                            </div>
                        </div>

                        {% if payment.description %}
                        <div class="vmp-body-small vmp-muted mb-3">
                            {{ payment.description }}
                        </div>
                        {% endif %}

                        <div class="flex items-center gap-2">
                            <a href="/payments/{{ payment.id }}" 
                               class="vmp-btn vmp-btn-ghost text-sm">
                                View Details
                            </a>
                            {% if payment.remittance_url %}
                            <a href="{{ payment.remittance_url }}" 
                               target="_blank"
                               class="vmp-btn vmp-btn-ghost text-sm">
                                View Remittance
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="flex items-center justify-center h-64">
            <div class="text-center">
                <div class="font-serif text-6xl italic opacity-35 mb-4">N</div>
                <div class="vmp-h3 mb-2">No Payment History</div>
                <div class="vmp-body vmp-muted">
                    No payments found matching your filters. Try adjusting your search criteria.
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Summary Stats -->
    {% if payments and payments|length > 0 %}
    <div class="mt-4 pt-4 border-t vmp-border-color">
        <div class="grid grid-cols-3 gap-4">
            <div>
                <div class="vmp-label-kicker opacity-50 mb-1">Total Payments</div>
                <div class="vmp-h4">{{ payments|length }}</div>
            </div>
            <div>
                <div class="vmp-label-kicker opacity-50 mb-1">Total Amount</div>
                <div class="vmp-h4">
                    {% set total = 0 %}
                    {% set currency = 'USD' %}
                    {% for payment in payments %}
                        {% set total = total + (payment.amount or 0) %}
                        {% if payment.currency_code %}{% set currency = payment.currency_code %}{% endif %}
                    {% endfor %}
                    {{ currency }} {{ "%.2f"|format(total) }}
                </div>
            </div>
            <div>
                <div class="vmp-label-kicker opacity-50 mb-1">With Remittance</div>
                <div class="vmp-h4">
                    {% set with_remittance = 0 %}
                    {% for payment in payments %}
                        {% if payment.remittance_url %}{% set with_remittance = with_remittance + 1 %}{% endif %}
                    {% endfor %}
                    {{ with_remittance }} / {{ payments|length }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

