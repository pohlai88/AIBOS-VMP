<!-- SOA Reconciliation Workspace (Enhanced 3-Column Layout) -->
<section class="vmp-panel" style="padding: var(--vmp-space-4);">
  <!-- Header -->
  <div style="display: flex; flex-direction: column; gap: var(--vmp-space-3); margin-bottom: var(--vmp-space-5);">
    <div style="min-width: 0;">
      <div class="vmp-label-kicker" style="margin-bottom: var(--vmp-space-2);">// soa reconciliation</div>
      <h2 class="vmp-h2" style="line-height: var(--vmp-line-height-tight);">
        Statement Workspace
      </h2>
      <p class="vmp-body" style="color: var(--vmp-subtle); margin-top: var(--vmp-space-2); max-width: 80ch;">
        Match statement claims to your ledger. Every variance becomes a case. No match is silent.
      </p>
    </div>

    <!-- Quick HUD -->
    <div class="vmp-panel" style="padding: var(--vmp-space-3) var(--vmp-space-4); display: flex; align-items: center; gap: var(--vmp-space-4);">
      <div style="min-width: 0;">
        <div class="vmp-label-kicker" style="margin-bottom: var(--vmp-space-1);">net variance</div>
        <div style="font-size: var(--vmp-font-2xl); font-weight: 300; letter-spacing: var(--vmp-letter-spacing-tight); color: {% if summary and summary.net_variance != 0 %}var(--vmp-danger){% else %}var(--vmp-text){% endif %};">
          {{ "%.2f"|format(summary.net_variance) if summary else "0.00" }}
        </div>
      </div>

      <div style="height: 40px; width: 1px; background: var(--vmp-border);"></div>

      <div style="min-width: 0;">
        <div class="vmp-label-kicker" style="margin-bottom: var(--vmp-space-1);">posture</div>
        <div class="vmp-label" style="text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">
          ACTION_REQUIRED
        </div>
      </div>

      <div style="height: 40px; width: 1px; background: var(--vmp-border);"></div>

      <button
        class="vmp-btn vmp-btn-primary"
        {% if not summary or summary.net_variance != 0 or summary.unmatched_lines > 0 %}disabled aria-disabled="true"{% endif %}
        hx-post="/api/soa/{{ caseId }}/signoff"
        hx-trigger="click"
        hx-target="#soa-toast"
        hx-swap="innerHTML">
        Digital Sign-off
      </button>
    </div>
  </div>

  <div style="margin-top: var(--vmp-space-5);">
    <!-- Responsive: 3 columns on large screens, stacked on mobile -->
    <style>
      @media (min-width: 1024px) {
        .vmp-soa-workspace-grid {
          display: grid !important;
          grid-template-columns: 1fr 2fr 1fr !important;
        }
      }
    </style>
    <div class="vmp-soa-workspace-grid" style="display: grid; grid-template-columns: 1fr; gap: var(--vmp-space-4);">
    <!-- LEFT: SOA Lines -->
    <aside class="vmp-panel" style="padding: var(--vmp-space-3);">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--vmp-space-3); margin-bottom: var(--vmp-space-3);">
        <div class="vmp-label-kicker">// lines</div>

        <div style="display: flex; align-items: center; gap: var(--vmp-space-2);">
          <input
            name="q"
            value="{{ q or '' }}"
            placeholder="Search doc no..."
            class="vmp-input"
            style="width: 176px;"
            hx-get="/soa/{{ caseId }}/lines"
            hx-trigger="keyup changed delay:250ms"
            hx-target="#soa-lines"
            hx-swap="innerHTML">
          <select
            name="status"
            class="vmp-select"
            style="width: 176px;"
            hx-get="/soa/{{ caseId }}/lines"
            hx-trigger="change"
            hx-target="#soa-lines"
            hx-swap="innerHTML">
            <option value="">All</option>
            <option value="extracted">Unmatched</option>
            <option value="matched">Matched exact</option>
            <option value="discrepancy">Disputed</option>
            <option value="resolved">Resolved</option>
          </select>
        </div>
      </div>

      <div id="soa-lines" style="display: flex; flex-direction: column; gap: var(--vmp-space-2); max-height: 62vh; overflow-y: auto; padding-right: var(--vmp-space-1);">
        {% if soaLines and soaLines.length > 0 %}
          {% for line in soaLines %}
            <button
              class="vmp-case-item"
              style="width: 100%; text-align: left;"
              hx-get="/soa/{{ caseId }}/lines/{{ line.id }}/focus"
              hx-trigger="click"
              hx-target="#soa-focus"
              hx-swap="innerHTML">
              <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: var(--vmp-space-3);">
                <div style="min-width: 0;">
                  <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">
                    INV Â· {{ line.invoice_date or 'N/A' }}
                  </div>
                  <div style="margin-top: var(--vmp-space-1); font-size: var(--vmp-font-sm); color: var(--vmp-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    {{ line.invoice_number or 'N/A' }}
                  </div>
                  <div style="margin-top: var(--vmp-space-1); font-size: var(--vmp-font-xs); color: var(--vmp-subtle);">
                    Amount: <span style="color: var(--vmp-text);">{{ line.currency_code }} {{ "%.2f"|format(line.amount) }}</span>
                  </div>
                </div>

                <span class="vmp-pill
                  {% if line.status == 'matched' %}vmp-pill-ok
                  {% elif line.status == 'discrepancy' %}vmp-pill-danger
                  {% else %}vmp-pill-warn{% endif %}">
                  {% if line.status == 'matched' %}MATCHED
                  {% elif line.status == 'discrepancy' %}DISPUTED
                  {% else %}UNMATCHED{% endif %}
                </span>
              </div>
            </button>
          {% endfor %}
        {% else %}
          <div class="vmp-empty" style="text-align: center; padding: var(--vmp-space-8);">
            <p class="vmp-body" style="color: var(--vmp-subtle);">No SOA lines found</p>
          </div>
        {% endif %}
      </div>
    </aside>

    <!-- CENTER: Focus + Matcher -->
    <section id="soa-focus" class="vmp-panel" style="padding: var(--vmp-space-4);">
      <!-- This block gets replaced by /lines/:id/focus -->
      <div class="vmp-label-kicker" style="margin-bottom: var(--vmp-space-3);">// select a line</div>
      <div class="vmp-body" style="color: var(--vmp-subtle);">
        Choose an SOA line to view suggested ledger matches, link evidence, or open a dispute.
      </div>
    </section>

    <!-- RIGHT: Live Variance HUD -->
    <aside class="vmp-panel" style="padding: var(--vmp-space-4);">
      <div class="vmp-label-kicker" style="margin-bottom: var(--vmp-space-3);">// variance hud</div>

      {% if summary %}
      <div style="display: flex; flex-direction: column; gap: var(--vmp-space-3);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">opening</div>
          <div class="vmp-body" style="font-size: var(--vmp-font-sm); color: var(--vmp-text);">{{ "%.2f"|format(summary.total_amount) }}</div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">matched</div>
          <div class="vmp-body" style="font-size: var(--vmp-font-sm); color: var(--vmp-text);">{{ "%.2f"|format(summary.matched_amount) }}</div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">statement-only</div>
          <div class="vmp-body" style="font-size: var(--vmp-font-sm); color: var(--vmp-text);">{{ "%.2f"|format(summary.unmatched_amount) }}</div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">ledger-only</div>
          <div class="vmp-body" style="font-size: var(--vmp-font-sm); color: var(--vmp-text);">0.00</div>
        </div>

        <div style="height: 1px; background: var(--vmp-border); margin: var(--vmp-space-2) 0;"></div>

        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="vmp-label" style="font-size: var(--vmp-font-xs); text-transform: uppercase; letter-spacing: var(--vmp-letter-spacing-wider); color: var(--vmp-subtle);">net variance</div>
          <div style="font-size: var(--vmp-font-lg); font-weight: 300; letter-spacing: var(--vmp-letter-spacing-tight); color: {% if summary.net_variance != 0 %}var(--vmp-danger){% else %}var(--vmp-text){% endif %};">
            {{ "%.2f"|format(summary.net_variance) }}
          </div>
        </div>

        <div style="height: 1px; background: var(--vmp-border); margin: var(--vmp-space-2) 0;"></div>

        <div class="vmp-body" style="font-size: var(--vmp-font-xs); color: var(--vmp-subtle); line-height: var(--vmp-line-height-relaxed);">
          Sign-off enables when variance is <span style="color: var(--vmp-text);">0.00</span>
          or within tolerance, and no disputes remain open.
        </div>

        <div style="display: flex; gap: var(--vmp-space-2); padding-top: var(--vmp-space-2);">
          <button
            class="vmp-btn vmp-btn-ghost"
            hx-post="/api/soa/{{ caseId }}/recompute"
            hx-trigger="click"
            hx-target="#soa-toast"
            hx-swap="innerHTML">
            Recompute
          </button>
          <button
            class="vmp-btn vmp-btn-ghost"
            hx-get="/api/soa/{{ caseId }}/export"
            hx-trigger="click"
            hx-target="#soa-toast"
            hx-swap="innerHTML">
            Export Pack
          </button>
        </div>
      </div>
      {% else %}
        <div class="vmp-empty" style="text-align: center; padding: var(--vmp-space-8);">
          <p class="vmp-body" style="color: var(--vmp-subtle);">No summary data available</p>
        </div>
      {% endif %}
    </aside>
    </div>
  </div>

  <div id="soa-toast" style="margin-top: var(--vmp-space-4);"></div>
</section>


